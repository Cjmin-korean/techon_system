<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영업수주등록</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../css/main.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

</head>
<style>
    #datatable-container {
        max-height: 1000px;
        /* Adjust the maximum height as needed */
        overflow-y: auto;
        /* Add vertical scrollbars if the content exceeds the container height */
    }

    .available {
        background-color: blue;
        color: white;
    }

    .shortage {
        background-color: red;
        color: white;
    }

    #datatable {
        width: 100%;
        /* Other table styles */
    }

    .left-column {
        width: 200px;
    }

    .right-column {
        text-align: right;
    }

    .blue-bg white-text {
        color: blue;
    }
</style>

</style>

<body>



    <div class="main_header">
        <a>생산 현장</a>
        <div class="buttons" style="display: flex; justify-content: flex-end;">
            <!-- <button onclick="New()">PO추가</button> -->
        </div>

    </div>
    <div id="loadingOverlay">
        <img src="/img/테크온로고.PNG" alt="로딩 이미지" class="loadingImage">

    </div>




    <div id="popupOverlay" style="display: none;">
        <div id="popupContent" style="width:50%; height: auto;">
            <div class="form-group">
                <table style="width:50%;" class="popuptable">
                    <tr>
                        <td colspan="1" class="popup_title">생산 자재 확인</td>
                    </tr>

                    <!-- 상위 3개 tr 왼쪽 -->

                    <tr>
                        <td class="left-column">BOMNO</td>
                        <td class="right-column">
                            <input type="text" id="bomno" class="data" autocomplete="off"
                                style="width:900px; border:1px solid silver;" readonly>
                        </td>
                    </tr>
                    <tr>
                        <td class="left-column">모델명</td>
                        <td class="right-column">
                            <input type="text" id="modelname" class="data" autocomplete="off"
                                style="width:900px; border:1px solid silver;" readonly>
                        </td>
                    </tr>

                    <!-- 나머지 3개 tr 오른쪽 -->
                    <tr>
                        <td class="left-column">제품명</td>
                        <td class="right-column">
                            <input type="text" id="partname" class="data" autocomplete="off"
                                style="width:900px; border:1px solid silver;" readonly>
                        </td>
                    </tr>
                    <tr>
                        <td class="left-column">생산lot</td>
                        <td class="right-column">
                            <input type="text" id="lotno" class="data" autocomplete="off"
                                style="width:900px; border:1px solid silver;" readonly>
                        </td>
                    </tr>
                    <tr>
                        <td class="left-column">발주수량</td>
                        <td class="right-column">
                            <input type="text" id="ponum" class="data" autocomplete="off"
                                style="width:900px; border:1px solid silver;" readonly>
                        </td>
                    </tr>
                </table>
            </div>




            <br>
            <div>

                <div style="width:auto; height:auto; max-height: 600px; overflow-y: scroll; border: 1px solid silver;">
                    <table class="styled-table" id="POdatatable-content1">
                        <thead>
                            <tr>
                                <th colspan="11" style="background-color: white;">출고자재</th>
                            </tr>
                            <tr>
                                <th>자재명</th>
                                <!-- <th>자재채번</th> -->
                                <th>분류</th>
                                <th>lotno</th>
                                <th>자재폭(mm)</th>
                                <th>출고수량(M)</th>
                                <th style="width:100px;"></th>

                            </tr>
                        </thead>
                        <tbody id="POdatatbody-content-tbody1">
                        </tbody>

                    </table>
                </div>
            </div>


            <button id="popupCloseBtn-content-close">취소</button>
            <button id="popupCloseBtn-content" onclick="Datasave()">준비완료</button>
        </div>
    </div>
    <div id="popupOverlay1" style="display: none;">
        <div id="popupContent" style="width:50%; height: auto;">
            <div class="form-group">
                <table style="width:50%;" class="popuptable">
                    <tr>
                        <td colspan="1" class="popup_title">잔재입력</td>
                    </tr>

                    <!-- 상위 3개 tr 왼쪽 -->

                    <tr>
                        <td class="left-column">BOMNO</td>
                        <td class="right-column">
                            <input type="text" id="bomno-finish" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;" readonly>
                        </td>
                    </tr>
                    <tr>
                        <td class="left-column">모델명</td>
                        <td class="right-column">
                            <input type="text" id="modelname-finish" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;" readonly>
                        </td>
                    </tr>

                    <!-- 나머지 3개 tr 오른쪽 -->
                    <tr>
                        <td class="left-column">제품명</td>
                        <td class="right-column">
                            <input type="text" id="partname-finish" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;" readonly>
                        </td>
                    </tr>
                    <tr>
                        <td class="left-column">생산lot</td>
                        <td class="right-column">
                            <input type="text" id="lotno-finish" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;" readonly>
                        </td>
                    </tr>
                    <tr>
                        <td class="left-column">발주수량</td>
                        <td class="right-column">
                            <input type="text" id="ponum-finish" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;" readonly>
                        </td>
                    </tr>
                </table>
            </div>




            <br>
            <div>

                <div style="width:auto; height:auto; max-height: 600px; overflow-y: scroll; border: 1px solid silver;">
                    <table class="styled-table" id="POdatatable-content2">
                        <thead>
                            <tr>
                                <th colspan="11" style="background-color: white;">잔고자재</th>
                            </tr>
                            <tr>
                                <th>자재명</th>
                                <!-- <th>자재채번</th> -->
                                <th>분류</th>
                                <th>LOT NO.</th>
                                <th>제조일자</th>
                                <th>만료일자</th>
                                <th>자재폭(mm)</th>
                                <th>잔재수량(M)</th>
                                <!-- <input type="button" value="console" onclick="rowcount()"> -->

                            </tr>
                        </thead>
                        <tbody id="POdatatbody-content-tbody2">
                        </tbody>

                    </table>
                </div>
            </div>


            <button id="popupCloseBtn-finish-close">취소</button>
            <button id="popupCloseBtn-content" onclick="productionfinish()">생산종료</button>
        </div>
    </div>




    <div id="datatable-container" style="height:50%;  border: 1px solid silver;">
        <table class="styled-table" id="POdatatable">

            <thead>
                <tr>
                    <th style="background-color:white;" colspan="8">
                        생산준비 자재 대기 현황
                    </th>
                </tr>
                <tr>

                    <th>생산계획날짜</th>
                    <th>BOMNO.</th>
                    <th>생산lot</th>
                    <th>모델명</th>
                    <th>제품명</th>
                    <th>발주수량</th>
                    <th style="background-color:rgb(232, 236, 243); width:100px;"></th>
                </tr>
            </thead>
            <tbody id="PODatatbody12">
            </tbody>
        </table>
    </div>
    <div id="datatable-container" style="height:50%;  border: 1px solid silver;">
        <table class="styled-table" id="productiondatatable">

            <thead>
                <tr>
                    <th style="background-color:white;" colspan="8">
                        생산중
                    </th>
                </tr>
                <tr>

                    <th>BOMNO.</th>
                    <th>생산lot</th>
                    <th>모델명</th>
                    <th>제품명</th>
                    <th>발주수량</th>
                    <th style="background-color:rgb(232, 236, 243); width:100px;"></th>
                </tr>
            </thead>
            <tbody id="productionDatatbody">
            </tbody>
        </table>
    </div>









    <script>
        var server = '';

        if (window.location.hostname == 'localhost') {
            server = 'http://localhost:8080';
        } else {
            server = 'https://mestechon.com';
        }
        $(document).ready(function () {
            showLoading()
            settingDate()
            $('#count-edit').on('input', function () {
                var value = $(this).val().replace(/[^0-9]/g, ''); // 숫자 이외의 문자 제거
                if (value === '') {
                    $(this).val('');
                } else {
                    $(this).val(parseInt(value, 10).toLocaleString());
                }
            });


            production()
            load23()
            load1()





            $('#POdatatable').on('click', '.data-content', function () {
                var str = "";
                var tdArr = new Array();// 배열 선언            
                var checkBtn = $(this);

                var tr = checkBtn.parent().parent();
                var td = tr.children();

                var bomno = td.eq(1).text();
                var lotno = td.eq(2).text();
                var modelname = td.eq(3).text();
                var partname = td.eq(4).text();
                var ponum = td.eq(5).text();

                // $('#pono').val(pono)
                $('#modelname').val(modelname)
                $('#bomno').val(bomno)
                $('#partname').val(partname)
                $('#lotno').val(lotno)
                $('#ponum').val(ponum)
                $.ajax({
                    type: 'POST',
                    url: server + '/api/materialoutputdata',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        // orderid: orderid
                    }),
                    success: function (result) {
                        $('#POdatatbody-content-tbody1').empty();

                        for (var i = 0; i < result.length; i++) {
                            // Determine CSS classes for styling based on availability
                            var availabilityClass = (result[i].availability === '가능') ? 'available' : 'shortage';

                            $('#POdatatbody-content-tbody1').append(
                                '<tr>' +
                                '<td>' + result[i].materialname + '</td>' +
                                '<td>' + result[i].classification + '</td>' +
                                '<td>' + result[i].lotno + '</td>' +
                                '<td>' + result[i].materialwidth + '</td>' +
                                '<td>' + result[i].quantity + '</td>' +

                                '<td><a class="data-check" style="cursor:pointer; color:blue;">확인</a></td>' +
                                '</tr>'
                            );
                        }
                    }
                });

                $('#popupOverlay').fadeIn()


            })
            $('#productiondatatable').on('click', '.data-finish', function () {
                // console.log(111)
                var str = "";
                var tdArr = new Array();// 배열 선언            
                var checkBtn = $(this);

                var tr = checkBtn.parent().parent();
                var td = tr.children();

                var bomno = td.eq(0).text();
                var lotno = td.eq(1).text();
                var modelname = td.eq(2).text();
                var partname = td.eq(3).text();
                var ponum = td.eq(4).text();

                // $('#pono').val(pono)
                $('#modelname-finish').val(modelname)
                $('#bomno-finish').val(bomno)
                $('#partname-finish').val(partname)
                $('#lotno-finish').val(lotno)
                $('#ponum-finish').val(ponum)
                $.ajax({
                    type: 'POST',
                    url: server + '/api/materialoutputdata',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        // orderid: orderid
                    }),
                    success: function (result) {
                        $('#POdatatbody-content-tbody2').empty();

                        for (var i = 0; i < result.length; i++) {

                            $('#POdatatbody-content-tbody2').append(
                                '<tr>' +
                                '<td id="' + result[i].materialname + '">' + result[i].materialname + '</td>' +
                                '<td id="' + result[i].classification + '">' + result[i].classification + '</td>' +
                                '<td id="' + result[i].lotno + '">' + result[i].lotno + '</td>' +
                                '<td id="' + result[i].manufacturedate + '">' + result[i].manufacturedate + '</td>' +
                                '<td id="' + result[i].expirationdate + '">' + result[i].expirationdate + '</td>' +
                                '<td id="' + result[i].materialwidth + '">' + result[i].materialwidth + '</td>' +
                                '<td><input type="text" id="remnants' + i + '" value="0" style="text-align:right; width:100px; border:1px solid silver; background-color: #f0f0f0; border-radius: 5px; padding: 5px; box-shadow: 2px 2px 2px #888;"></td>' +


                                // '<td><a class="data-check" style="cursor:pointer; color:blue;">확인</a></td>' +
                                '</tr>'
                            );
                        }
                    }
                });

                $('#popupOverlay1').fadeIn()


            })
            // 확인 버튼 클릭 이벤트 처리
            $('#POdatatbody-content-tbody1').on('click', '.data-check', function () {
                // 클릭한 행을 찾기
                var clickedRow = $(this).closest('tr');

                // 클릭한 행의 배경색 변경 (예: 노란색)
                clickedRow.css('background-color', 'lime');
            });

            $('#materialsoyodatatable').on('click', '.data-output', function () {

                $(this).closest('tr').remove();
                const date = new Date();

                var day = date.getDate();
                var month = date.getMonth() + 1;
                var year = date.getFullYear();


                if (month === 1 || month === 2 || month === 3 || month === 4 || month === 5 || month === 6 || month === 7 || month === 8 || month === 9) {
                    month = '0' + month
                }

                if (day === 1 || day === 2 || day === 3 || day === 4 || day === 5 || day === 6 || day === 7 || day === 8 || day === 9) {
                    day = '0' + day
                }


                // This arrangement can be altered based on how we want the date's format to appear.
                let currentDate = `${year}-${month}-${day}`;

                var str = "";
                var tdArr = new Array();// 배열 선언            
                var checkBtn = $(this);

                var tr = checkBtn.parent().parent();
                var td = tr.children();

                var materialname = td.eq(0).text();
                var codenumber = td.eq(1).text();
                var customer = td.eq(2).text();
                var classification = td.eq(3).text();
                var lotno = td.eq(4).text();
                var manufacturedate = td.eq(5).text();
                var expirationdate = td.eq(6).text();
                var materialwidth = td.eq(7).text();
                var materialwidth1 = materialwidth.replace(/,/g, "");
                var quantity = td.eq(8).text();
                var quantity1 = quantity.replace(/,/g, "");
                // var sqmprice = td.eq(9).text();
                var house = td.eq(9).text();
                var materialid = td.eq(10).text();
                var orderid = $('#orderid').val()

                $.ajax({
                    type: 'POST',
                    url: server + '/api/materialsoyooutput',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        date: currentDate,
                        input: '원자재출고',
                        materialname: materialname,
                        codenumber: codenumber,
                        lotno: lotno,
                        manufacturedate: manufacturedate,
                        expirationdate: expirationdate,
                        materialwidth: materialwidth1,
                        classification: classification,
                        // sqmprice: sqmprice,
                        house: house,
                        materialid: materialid,
                        orderid: orderid,
                        roll: '1',
                        customer: customer,
                        quantity: parseInt(-quantity1),
                        part: '출고대기',
                        productlot: $('#lotno').val()
                    }),
                    success: function (result) {



                    }

                })
                // Append data rows
                var newRow = '<tr>' +
                    '<td>' + materialname + '</td>' +
                    '<td>' + codenumber + '</td>' +
                    '<td>' + classification + '</td>' +
                    '<td>' + lotno + '</td>' +
                    '<td>' + manufacturedate + '</td>' +
                    '<td>' + expirationdate + '</td>' +
                    '<td style="text-align:right;">' + materialwidth + '</td>' +
                    '<td style="text-align:right;">' + quantity + '</td>' +
                    // '<td style="text-align:right;">' + sqmprice + '</td>' +
                    '<td>' + house + '</td>' +
                    '<td id="soyomaterialid">' + materialid + '</td>' +
                    '<td><a class="soyo-output" style="cursor:pointer; color:red;">삭제</a></td>' +
                    '</tr>';

                $('#POdatatbody-content-tbody1').append(newRow);
                $("td#soyomaterialid").hide();

                // Calculate the sum of the quantity column
                var totalQuantity = 0;
                var materialGroups = {};

                // Append data rows and calculate total quantity for each material group
                $('#POdatatbody-content-tbody1 tr').each(function () {
                    var material = $(this).find('td:nth-child(1)').text();
                    var quantityValue = parseFloat($(this).find('td:nth-child(8)').text().replace(/,/g, ''));
                    if (!isNaN(quantityValue)) {
                        totalQuantity += quantityValue;
                        if (material in materialGroups) {
                            materialGroups[material] += quantityValue;
                        } else {
                            materialGroups[material] = quantityValue;
                        }
                    }
                });
                // Remove existing total row
                $('.total-row').remove();

                // Remove existing material group rows
                $('.material-group-row').remove();

                // Check if there is any data
                var hasData = $('#POdatatable-content1 tr').length > 1;

                // Append the total row if there is data
                // Append the total row if there is data
                if (hasData) {


                    $('#POdatatable-content1').append(
                        '<tr class="total-row" style="background-color:whitesmoke; color:black;">' +
                        '<td colspan="7" style="text-align:right;"><strong>합계:</strong></td>' +
                        '<td style="text-align:right;"><strong><span>' + totalQuantity.toLocaleString() + '</span></strong></td>' +
                        '<td colspan="3"></td>' +
                        '</tr>'
                    );
                    // if (materialname) {
                    //     $('#HGCS-A305YA+SJ-2502LS-W(D)').val(totalQuantity.toLocaleString());
                    // }
                    // var escapedMaterialName = jQuery.escapeSelector(materialname);

                    console.log(totalQuantity.toLocaleString())
                    // Append material group rows with total quantity if there is data
                    for (var material in materialGroups) {
                        var groupQuantity = materialGroups[material];
                        $('#POdatatable-content1').append(
                            '<tr class="material-group-row">' +
                            '<td colspan="7" style="text-align:right;"><strong>' + material + ' 합계:</strong></td>' +
                            '<td style="text-align:right;"><strong>' + groupQuantity.toLocaleString() + '</strong></td>' +
                            '<td colspan="3"></td>' +
                            '</tr>'
                        );
                    }
                    $.ajax({
                        type: 'POST',
                        url: server + '/api/bommanagement1materialinput',
                        dataType: 'json',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            pono: $('#pono').val(),
                            lotno: $('#lotno').val(),
                            materialinput: groupQuantity,
                            materialname: material

                        }),
                        success: function (result) {



                        }

                    })
                    // $('#materialname').val(totalQuantity.toLocaleString());

                    // var escapedMaterialName = jQuery.escapeSelector(materialname);
                    // $('#POdatatable-content #' + escapedMaterialName).text(groupQuantity.toLocaleString());
                    // $('#POdatatbody-content-tbody').empty
                    // $('#POdatatbody-content-tbody').append(
                    //     '<tr>' +
                    //     '<td>' + result[i].materialname + '</td>' +
                    //     '<td style="text-align:right;">' + result[i].swidth.toLocaleString() + '</td>' +
                    //     '<td id="' + result[i].materialname + 'soyo' + '"  class="soyo-value" style="text-align:right;">' + result[i].soyo.toLocaleString() + '</td>' +
                    //     '<td id="' + result[i].materialname + 'quantity' + '" style="text-align:right;">' + result[i].quantity.toLocaleString() + '</td>' +
                    //     '<td id="' + result[i].materialname + '" style="text-align:right;">0</td>' +
                    //     '<td id="' + result[i].materialname + 'availability" style="text-align:right;"  class="' + (result[i].availability === '가능' ? 'blue' : 'red') + '"></td>' +
                    //     '<td><a class="data-edit" style="cursor:pointer; color:blue;">출고</a></td>' +
                    //     '</tr>'
                    // );

                }



            })
            $('#POdatatable-content1').on('click', '.soyo-output', function () {
                var str = "";
                var tdArr = new Array();// 배열 선언            
                var checkBtn = $(this);

                var tr = checkBtn.parent().parent();
                var td = tr.children();

                var materialid = td.eq(10).text();
                var quantity = td.eq(7).text();
                var quantity1 = quantity.replace(/,/g, "");


                $.ajax({
                    type: 'POST',
                    url: server + '/api/materialsoyodelete',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        materialid: materialid,
                        quantity: parseInt(-quantity1)

                    }),
                    success: function (result) {




                    }

                })
                $(this).closest('tr').remove();

                // Calculate the sum of the quantity column
                var totalQuantity = 0;
                var materialGroups = {};

                // Append data rows and calculate total quantity for each material group
                $('#POdatatable-content1 tr').each(function () {
                    var material = $(this).find('td:nth-child(1)').text();
                    var quantityValue = parseFloat($(this).find('td:nth-child(8)').text().replace(/,/g, ''));
                    if (!isNaN(quantityValue)) {
                        totalQuantity += quantityValue;
                        if (material in materialGroups) {
                            materialGroups[material] += quantityValue;
                        } else {
                            materialGroups[material] = quantityValue;
                        }
                    }
                });

                // Remove existing total row
                $('.total-row').remove();

                // Remove existing material group rows
                $('.material-group-row').remove();

                // Check if there is any data
                var hasData = $('#POdatatable-content1 tr').length > 1;

                // Append the total row if there is data
                if (hasData) {
                    $('#POdatatable-content1').append(
                        '<tr class="total-row" style="background-color:whitesmoke; color:black;">' +
                        '<td colspan="7" style="text-align:right;"><strong>합계:</strong></td>' +
                        '<td style="text-align:right;"><strong>' + totalQuantity.toLocaleString() + '</strong></td>' +
                        '<td colspan="3"></td>' +
                        '</tr>'
                    );

                    // Append material group rows with total quantity if there is data
                    for (var material in materialGroups) {
                        var groupQuantity = materialGroups[material];
                        $('#POdatatable-content1').append(
                            '<tr class="material-group-row">' +
                            '<td colspan="7" style="text-align:right;"><strong>' + material + ' 합계:</strong></td>' +
                            '<td style="text-align:right;"><strong>' + groupQuantity.toLocaleString() + '</strong></td>' +
                            '<td colspan="3"></td>' +
                            '</tr>'
                        );
                    }
                }
                $('#sumquantity').val(totalQuantity.toLocaleString());
            })
            $('#POdatatable-content').on('click', '.data-edit', function () {
                var str = "";
                var tdArr = new Array();// 배열 선언            
                var checkBtn = $(this);

                var tr = checkBtn.parent().parent();
                var td = tr.children();

                var materialname = td.eq(0).text();
                var materialwidth = td.eq(1).text();
                console.log(materialname)
                $.ajax({
                    type: 'POST',
                    url: server + '/api/materialsoyosearch',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        materialname: materialname,
                        materialwidth: parseInt(materialwidth)
                    }),
                    success: function (result) {
                        $('#materialseachbody').empty()

                        for (var i = 0; i < result.length; i++) {
                            $('#materialseachbody').append(
                                '<tr>' +
                                '<td >' + result[i].materialname + '</td>' +
                                '<td >' + result[i].codenumber + '</td>' +
                                '<td >' + result[i].customer + '</td>' +
                                '<td >' + result[i].classification + '</td>' +
                                '<td >' + result[i].lotno + '</td>' +
                                '<td >' + result[i].manufacturedate + '</td>' +
                                '<td >' + result[i].expirationdate + '</td>' +
                                '<td style="text-align:right;">' + result[i].materialwidth.toLocaleString() + '</td>' +
                                '<td style="text-align:right;">' + result[i].quantity.toLocaleString() + '</td>' +
                                // '<td style="text-align:right;">' + result[i].sqmprice.toLocaleString() + '</td>' +
                                '<td>' + result[i].house + '</td>' +
                                '<td id="materialid">' + result[i].materialid + '</td>' +
                                '<td><a class="data-output" style="cursor:pointer; color:blue;">출고</a></td>' +
                                '</tr>'

                            )
                            $("td#materialid").hide();
                        }

                    }

                })
                $('#popupOverlay1').fadeIn()
            })

            function deleteRow(element) {
                var row = $(element).closest('tr'); // Get the closest <tr> element
                row.remove(); // Remove the row from the table
            }

            $('#datatable').on('click', '.data-edit', function () {
                var str = "";
                var tdArr = new Array();// 배열 선언            
                var checkBtn = $(this);

                var tr = checkBtn.parent().parent();
                var td = tr.children();

                var itemcode = td.eq(0).text();
                var bomno = td.eq(1).text();
                var modelname = td.eq(2).text();
                var itemname = td.eq(3).text();
                var customer = td.eq(4).text();
                var itemprice = td.eq(5).text();
                var cost = td.eq(6).text();
                var costpg = td.eq(7).text();
                var id = td.eq(10).text();

                $('#itemcode-edit').val(itemcode)
                $('#bomno-edit').val(bomno)
                $('#modelname-edit').val(modelname)
                $('#itemname-edit').val(itemname)
                $('#customer-edit').val(customer)
                $('#itemprice-edit').val(itemprice)
                $('#cost-edit').val(cost)
                $('#costpg-edit').val(costpg)
                $('#id-edit').val(id)
                $('#count-edit').val('')

                $('#popupOverlay1').fadeIn();
                $('#count-edit').focus()
            });
            $('#POdatatable1').on('click', '.datadelete', function () {
                var str = "";
                var tdArr = new Array();// 배열 선언            
                var checkBtn = $(this);

                var tr = checkBtn.parent().parent();
                var td = tr.children();

                var id = td.eq(0).text();
                $('#id-edit1').val(id);
                $('#popupOverlay2').fadeIn();

            })
            $('#Podatatable').on('click', '.POdata-edit', function () {
                var clickedRow = $(this); // 클릭한 행(tr) 요소
                var rowIndex = clickedRow.index() + 1; // 클릭한 행의 인덱스 + 1

                var str = "";
                var tdArr = new Array();// 배열 선언            
                var checkBtn = $(this);

                var tr = checkBtn.parent().parent();
                var td = tr.children();

                var itemcode = td.eq(0).text();
                var bomno = td.eq(1).text();
                var modelname = td.eq(2).text();
                var itemname = td.eq(3).text();
                var customer = td.eq(4).text();
                var itemprice = td.eq(5).text();
                var cost = td.eq(6).text();
                var costpg = td.eq(7).text();

                $('#itemcode-POedit').val(itemcode)
                $('#bomno-POedit').val(bomno)
                $('#modelname-POedit').val(modelname)
                $('#itemname-POedit').val(itemname)
                $('#customer-POedit').val(customer)
                $('#itemprice-POedit').val(itemprice)
                $('#cost-POedit').val(cost)
                $('#costpg-POedit').val(costpg)
                $('#count-POedit').val('')
                $('#id-POedit').val(rowIndex)
                $('#popupOverlay4').fadeIn();
                $('#count-POedit').focus()
            });




            $('#datatable').on('click', '.data-delete', function () {
                var str = "";
                var tdArr = new Array();// 배열 선언            
                var checkBtn = $(this);

                var tr = checkBtn.parent().parent();
                var td = tr.children();


                var id = td.eq(0).text();
                $('#id-edit').val(id)
                $('#popupOverlay2').fadeIn();
            });


            $('#popupCloseBtn-save-close').click(function () {
                $('#popupOverlay').fadeOut();
            });
            $('#popupCloseBtn-edit-close').click(function () {
                $('#popupOverlay1').fadeOut();
            });
            $('#popupCloseBtn-delete-close').click(function () {
                $('#popupOverlay2').fadeOut();
            });
            $('#popupCloseBtn-search-close').click(function () {
                $('#popupOverlay3').fadeOut();
            });
            $('#popupCloseBtn-search').click(function () {
                $('#popupOverlay3').fadeIn();
            });
            $('#popupCloseBtn-content-close').click(function () {
                $('#popupOverlay').fadeOut();
            });
            $('#popupCloseBtn-finish-close').click(function () {
                $('#popupOverlay1').fadeOut();
            });
            $('#popupCloseBtn-POedit-close').click(function () {
                $('#popupOverlay4').fadeOut();
            });


            const selectElement = document.getElementById("customer-select");
            if (selectElement) {
                $.ajax({
                    type: 'POST',
                    url: server + '/api/accountnamegroup',
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (result) {
                        for (let i = 0; i < result.length; i++) {
                            const option = document.createElement("option");
                            option.text = result[i].accountname;
                            option.value = result[i].accountname;
                            selectElement.add(option);
                        }
                    },
                });
            }

        });





        //검색
        function search() {
            const searchInput = document.getElementById('myInput');
            const dataTable = document.getElementById('datatable');
            const tableRows = dataTable.getElementsByTagName('tr');

            searchInput.addEventListener('input', function () {
                const searchValue = this.value.toLowerCase();

                for (let i = 1; i < tableRows.length; i++) {
                    const rowData = tableRows[i].getElementsByTagName('td');

                    let found = false;

                    for (let j = 0; j < rowData.length; j++) {
                        const cellData = rowData[j].textContent.toLowerCase();

                        if (cellData.includes(searchValue)) {
                            found = true;
                            break;
                        }
                    }

                    if (found) {
                        tableRows[i].style.display = '';
                    } else {
                        tableRows[i].style.display = 'none';
                    }

                }
            });
        }
        function showLoading() {
            var loadingOverlay = document.getElementById("loadingOverlay");
            loadingOverlay.style.display = "flex";

            // 로딩 완료 후 일정 시간 후 로딩 창 숨기기 (테스트용)
            setTimeout(function () {
                loadingOverlay.style.display = "none";
            }, 1000);
        }

        function New() {
            $('#POdatatbody').empty();
            var total8 = 0;
            var total9 = 0;
            $('#Podatatable td:nth-child(8)').each(function () {
                var count8 = parseFloat($(this).text().replace(/,/g, ''));
                if (!isNaN(count8)) {
                    total8 += count8;
                }
            });

            $('#Podatatable td:nth-child(9)').each(function () {
                var count9 = parseFloat($(this).text().replace(/,/g, ''));
                if (!isNaN(count9)) {
                    total9 += count9;
                }
            });
            // 합계 표시
            $('#Podatatable tfoot').remove(); // 기존의 tfoot 제거
            $('#Podatatable').append(
                '<tfoot>' +
                '<tr>' +
                '<td style="border:1px solid silver; background-color:whitesmoke;"colspan="7">합계</td>' +
                '<td style="border:1px solid silver; text-align:right;"><strong>' + addCommas(total8.toFixed(0)) + '</strong></td>' +
                '<td style="border:1px solid silver; text-align:right;"><strong>' + addCommas(total9.toFixed(0)) + '</strong></td>' +
                '<td style="border:1px solid silver; background-color:whitesmoke; "colspan="2"></td>' +
                '</tr>' +
                '</tfoot>'
            );
            $('#popupOverlay').fadeIn();
        }

        function Datasave() {
            if (confirm("생산준비 완료하시겠습니까?") == true) {
                $.ajax({
                    type: 'POST',
                    url: server + '/api/updateproduction',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({

                        status1: '생산중',
                        lotno: $('#lotno').val()
                    }),
                    success: function (result) {

                    }
                });
                $.ajax({
                    type: 'POST',
                    url: server + '/api/updatemtstatus',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({

                        mstatus: '',
                        lotno: $('#lotno').val()
                    }),
                    success: function (result) {

                    }
                });



                $('#popupOverlay').fadeOut();
                setTimeout(function () {
                    load1();
                    load23();
                    production()
                }, 30);
            } else {
                return false;
            }
        }
        function productionfinish() {
            if (confirm("생산을 종료 하시겠습니까?") == true) {
                $.ajax({
                    type: 'POST',
                    url: server + '/api/updateproduction',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({

                        status1: '생산종료',
                        lotno: $('#lotno-finish').val()
                    }),
                    success: function (result) {

                    }
                });

                var today = new Date();
                var year = today.getFullYear(); // 연도
                var month = today.getMonth() + 1; // 월 (0부터 시작하므로 1을 더해줍니다)
                var day = today.getDate(); // 일

                // 월과 일이 한 자리 숫자인 경우 두 자리로 만들어줍니다 (예: 2023-10-28)
                if (month < 10) {
                    month = '0' + month;
                }

                if (day < 10) {
                    day = '0' + day;
                }

                var currentDate = year + '-' + month + '-' + day;


                const $table = document.getElementById('POdatatable-content2'); // table 엘리먼트 취득
                const trGroup = Array.from(document.querySelectorAll('#POdatatable-content2 tr'));

                const textGroup = trGroup.map(tr => {
                    return Array.from(tr.children).map(input => input.textContent);
                });

                for (var i = 0; i < $table.rows.length - 2; i++) {

                    var remant = $('#remnants' + i + '').val()
                    if (remant !== '0') {
                        $.ajax({
                            type: 'POST',
                            url: server + '/api/insertmaterialinput',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify({

                                date: currentDate,
                                input: '생산후입고',
                                materialname: textGroup[i + 2][0],
                                classification: textGroup[i + 2][1],
                                lotno: textGroup[i + 2][2],
                                codenumber: textGroup[i + 2][0],
                                manufacturedate: textGroup[i + 2][3],
                                expirationdate: textGroup[i + 2][4],
                                materialwidth: textGroup[i + 2][5],
                                quantity: $('#remnants' + i + '').val(),
                                roll: '1',
                                house: '원자재창고',
                                customer: '영풍전자',
                                part: '무검사항목'

                            }),
                            success: function (result) {

                            }
                        });
                    } else {
                        // remant가 0인 경우에 실행할 코드

                    }


                }
                // date,input,materialname,lotno,manufacturedate,expirationdate,materialwidth,quantity,roll,sum,contents,part




                var notification = $('<div class="notification"><img src="/img/테크온로고.PNG" alt="Notification Icon"><span style="font-weight:bold; color:navy;" class="notification-message">생산이 완료되었습니다.</span></div>');
                $('body').append(notification);
                setTimeout(function () {
                    notification.fadeOut(function () {
                        $(this).remove();
                    });
                }, 3000);
                $('#popupOverlay1').fadeOut();
                setTimeout(function () {
                    load1();
                    load23();
                    production()
                }, 30);
            } else {
                return false;
            }
        }






        function PODataedit() {



            if ($('#count-POedit').val() === '' || $('#count-POedit').val() === '0') {
                var notification = $('<div class="notification"><img src="/img/테크온로고.PNG" alt="Notification Icon"><span style="font-weight:bold; color:red;" class="notification-message">PO수량 확인바랍니다</span></div>');
                $('body').append(notification);
                setTimeout(function () {
                    notification.fadeOut(function () {
                        $(this).remove();
                    });
                }, 3000);

            } else {
                var tr = $(this).closest('tr'); // 현재 버튼이 속한 행(tr)을 가져옵니다.
                var tdArr = tr.find('td'); // 행(tr)에서 모든 셀(td)을 가져옵니다.

                var POeditcount = $('#count-POedit', window.opener.document).val(); // 다른 창에서 값을 가져옵니다.

                // 원하는 셀에 접근하여 값을 변경합니다.
                tdArr.eq(7).text(POeditcount); // 8번째 셀의 값을 변경 (0부터 시작하는 인덱스)


                $('#popupOverlay4').fadeOut();

                var total8 = 0;
                var total9 = 0;
                $('#Podatatable td:nth-child(8)').each(function () {
                    var count8 = parseFloat($(this).text().replace(/,/g, ''));
                    if (!isNaN(count8)) {
                        total8 += count8;
                    }
                });

                $('#Podatatable td:nth-child(9)').each(function () {
                    var count9 = parseFloat($(this).text().replace(/,/g, ''));
                    if (!isNaN(count9)) {
                        total9 += count9;
                    }
                });
                // 합계 표시
                $('#Podatatable tfoot').remove(); // 기존의 tfoot 제거
                $('#Podatatable').append(
                    '<tfoot>' +
                    '<tr>' +
                    '<td style="border:1px solid silver; background-color:whitesmoke;"colspan="7">합계</td>' +
                    '<td style="border:1px solid silver; text-align:right;"><strong>' + addCommas(total8.toFixed(0)) + '</strong></td>' +
                    '<td style="border:1px solid silver; text-align:right;"><strong>' + addCommas(total9.toFixed(0)) + '</strong></td>' +
                    '<td style="border:1px solid silver; background-color:whitesmoke; "colspan="2"></td>' +
                    '</tr>' +
                    '</tfoot>'
                );

                var notification = $('<div class="notification"><img src="/img/테크온로고.PNG" alt="Notification Icon"><span style="font-weight:bold; color:navy;" class="notification-message">PO수량 수정되었습니다</span></div>');
                $('body').append(notification);
                setTimeout(function () {
                    notification.fadeOut(function () {
                        $(this).remove();
                    });
                }, 3000); // 3초 후에 알림을 사라지게 설정
            }

        }

        function Dataedit() {
            if ($('#count-edit').val() === '' || $('#count-edit').val() === '0') {
                var notification = $('<div class="notification"><img src="/img/테크온로고.PNG" alt="Notification Icon"><span style="font-weight:bold; color:red;" class="notification-message">PO수량 확인바랍니다</span></div>');
                $('body').append(notification);
                setTimeout(function () {
                    notification.fadeOut(function () {
                        $(this).remove();
                    });
                }, 3000); // 3초 후에 알림을 사라지게 설정

            } else {
                var count = $('#count-edit').val().replace(/[^0-9]/g, ''); // 숫자 이외의 문자 제거
                var item = $('#itemprice-edit').val().replace(/[^0-9]/g, ''); // 숫자 이외의 문자 제거
                var total = count * item;

                $('#Podatatable').append(
                    '<tr>' +
                    '<td>' + $('#itemcode-edit').val() + '</td>' +
                    '<td>' + $('#bomno-edit').val() + '</td>' +
                    '<td>' + $('#modelname-edit').val() + '</td>' +
                    '<td>' + $('#itemname-edit').val() + '</td>' +
                    '<td>' + $('#customer-edit').val() + '</td>' +
                    '<td style="text-align:right;">' + $('#cost-edit').val() + '</td>' +
                    '<td style="text-align:right;">' + addCommas($('#itemprice-edit').val()) + '</td>' +
                    '<td style="text-align:right;">' + addCommas($('#count-edit').val()) + '</td>' +
                    '<td style="text-align:right;">' + addCommas(total.toLocaleString()) + '</td>' +
                    '<td><a class="POdata-edit"  style="cursor:pointer; color:navy;">수정</a></td>' +
                    '<td><a class="data-delete" style="cursor:pointer; color:red;">삭제</a></td>' +
                    '</tr>'

                )
                // 합계 계산
                var total8 = 0;
                var total9 = 0;
                $('#Podatatable td:nth-child(8)').each(function () {
                    var count8 = parseFloat($(this).text().replace(/,/g, ''));
                    if (!isNaN(count8)) {
                        total8 += count8;
                    }
                });

                $('#Podatatable td:nth-child(9)').each(function () {
                    var count9 = parseFloat($(this).text().replace(/,/g, ''));
                    if (!isNaN(count9)) {
                        total9 += count9;
                    }
                });
                // 합계 표시
                $('#Podatatable tfoot').remove(); // 기존의 tfoot 제거
                $('#Podatatable').append(
                    '<tfoot>' +
                    '<tr>' +
                    '<td style="border:1px solid silver; background-color:whitesmoke;"colspan="7">합계</td>' +
                    '<td style="border:1px solid silver; text-align:right;"><strong>' + addCommas(total8.toFixed(0)) + '</strong></td>' +
                    '<td style="border:1px solid silver; text-align:right;"><strong>' + addCommas(total9.toFixed(0)) + '</strong></td>' +
                    '<td style="border:1px solid silver; background-color:whitesmoke; "colspan="2"></td>' +
                    '</tr>' +
                    '</tfoot>'
                );



                var notification = $('<div class="notification"><img src="/img/테크온로고.PNG" alt="Notification Icon"><span class="notification-message">' + $('#itemname-edit').val() + '(' + $('#count-edit').val() + ') 제품이 추가되었습니다.</span></div>');
                $('body').append(notification);
                setTimeout(function () {
                    notification.fadeOut(function () {
                        $(this).remove();
                    });
                }, 3000); // 3초 후에 알림을 사라지게 설정


                $('#popupOverlay1').fadeOut();
            }

        }

        // 천 단위마다 콤마를 추가하는 함수
        function addCommas(value) {
            return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function Datadelte() {
            $.ajax({
                type: 'POST',
                url: server + '/api/materialoutputdelete',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({
                    orderid: $('#id-edit1').val(),
                    materialstatus: 'true'
                }),
                success: function (result) {

                }
            });
            var notification = $('<div class="notification"><img src="/img/테크온로고.PNG" alt="Notification Icon"><span class="notification-message" styel="color:red;">출고대기 삭제완료</span></div>');
            $('body').append(notification);
            setTimeout(function () {
                notification.fadeOut(function () {
                    $(this).remove();
                });
            }, 3000);

            $('#popupOverlay2').fadeOut();
            setTimeout(function () {
                load1();
                load23();
                production()
            }, 30);
        }


        $(document).on('click', '.data-delete', function () {
            $(this).closest('tr').remove();
            var total8 = 0;
            var total9 = 0;
            $('#Podatatable td:nth-child(8)').each(function () {
                var count8 = parseFloat($(this).text().replace(/,/g, ''));
                if (!isNaN(count8)) {
                    total8 += count8;
                }
            });

            $('#Podatatable td:nth-child(9)').each(function () {
                var count9 = parseFloat($(this).text().replace(/,/g, ''));
                if (!isNaN(count9)) {
                    total9 += count9;
                }
            });
            // 합계 표시
            $('#Podatatable tfoot').remove(); // 기존의 tfoot 제거
            $('#Podatatable').append(
                '<tfoot>' +
                '<tr>' +
                '<td style="border:1px solid silver; background-color:whitesmoke;"colspan="7">합계</td>' +
                '<td style="border:1px solid silver; text-align:right;"><strong>' + addCommas(total8.toFixed(0)) + '</strong></td>' +
                '<td style="border:1px solid silver; text-align:right;"><strong>' + addCommas(total9.toFixed(0)) + '</strong></td>' +
                '<td style="border:1px solid silver; background-color:whitesmoke; "colspan="2"></td>' +
                '</tr>' +
                '</tfoot>'
            );

            var notification = $('<div class="notification"><img src="/img/테크온로고.PNG" alt="Notification Icon"><span class="notification-message"> 제품이 삭제되었습니다.</span></div>');
            $('body').append(notification);
            setTimeout(function () {
                notification.fadeOut(function () {
                    $(this).remove();
                });
            }, 3000); // 3초 후에 알림을 사라지게 설정
        });
        $(document).on('click', '.POdata-edit', function () {
        })




    </script>
    <script>
        function settingDate() {
            const date = new Date();

            var day = date.getDate();
            var month = date.getMonth() + 1;
            var year = date.getFullYear();


            if (month === 1 || month === 2 || month === 3 || month === 4 || month === 5 || month === 6 || month === 7 || month === 8 || month === 9) {
                month = '0' + month
            }

            if (day === 1 || day === 2 || day === 3 || day === 4 || day === 5 || day === 6 || day === 7 || day === 8 || day === 9) {
                day = '0' + day
            }


            // This arrangement can be altered based on how we want the date's format to appear.
            let currentDate = `${year}-${month}-${day}`;


            $('#datepicker').val(currentDate);
            $('#datepicker1').val(currentDate);
            $('#datepicker2').val(currentDate);

        }
    </script>
    <script>
        function load23() {
            $.ajax({
                type: 'POST',
                url: server + '/api/productionmaterialouput',
                dataType: 'json',
                contentType: 'application/json',
                success: function (result) {
                    var tbody = $('#PODatatbody12');
                    tbody.empty(); // tbody 초기화
                    if (result.length === 0) {
                        $('#POdatatable').append('<tr><td colspan="8" style="font-weight:bold; text-align:center;">데이터가 없습니다</td></tr>');
                    } else {
                        for (var i = 0; i < result.length; i++) {
                            tbody.append(
                                '<tr>' +
                                '<td>' + result[i].productdate + '</td>' +
                                '<td>' + result[i].bomno + '</td>' +
                                '<td>' + result[i].lotno + '</td>' +
                                '<td>' + result[i].modelname + '</td>' +
                                '<td>' + result[i].itemname + '</td>' +
                                '<td>' + result[i].quantity.toLocaleString() + '</td>' +
                                '<td><a class="data-content"  style="cursor:pointer; color:blue;">상세</a></td>' +
                                '</tr>'
                            );
                        }
                    }
                }
            });
        }

        function production() {
            $.ajax({
                type: 'POST',
                url: server + '/api/productioning',
                dataType: 'json',
                contentType: 'application/json',
                success: function (result) {
                    var tbody = $('#productionDatatbody');
                    tbody.empty(); // tbody 초기화
                    if (result.length === 0) {
                        $('#productiondatatable').append('<tr><td colspan="8" style="font-weight:bold; text-align:center;">데이터가 없습니다</td></tr>');
                    } else {
                        for (var i = 0; i < result.length; i++) {
                            tbody.append(
                                '<tr>' +
                                // '<td>' + result[i].productdate + '</td>' +
                                '<td>' + result[i].bomno + '</td>' +
                                '<td>' + result[i].lotno + '</td>' +
                                '<td>' + result[i].modelname + '</td>' +
                                '<td>' + result[i].itemname + '</td>' +
                                '<td>' + result[i].quantity.toLocaleString() + '</td>' +
                                '<td><a class="data-finish"  style="cursor:pointer; color:blue;">생산종료</a></td>' +
                                '</tr>'
                            );
                        }
                    }
                }
            });
        }

        function load1() {
            $.ajax({
                type: 'POST',
                url: server + '/api/materialouput1',
                dataType: 'json',
                contentType: 'application/json',
                success: function (result) {
                    var tbody = $('#PODatatbody34');
                    tbody.empty(); // tbody 초기화
                    if (result.length === 0) {
                        $('#POdatatable1').append('<tr><td colspan="8" style="font-weight:bold; text-align:center;">데이터가 없습니다</td></tr>');
                    } else {
                        for (var i = 0; i < result.length; i++) {
                            // 스타일 및 색상을 결정하는 클래스 설정
                            var mstatusClass = (result[i].mstatus === '자재완전출고') ? 'blue-bg white-text' : 'yellow-bg black-text';

                            tbody.append(
                                '<tr class="' + mstatusClass + '">' +
                                '<td>' + result[i].orderid + '</td>' +
                                '<td>' + result[i].productdate + '</td>' +
                                '<td>' + result[i].lotno + '</td>' +
                                '<td>' + result[i].bomno + '</td>' +
                                '<td>' + result[i].modelname + '</td>' +
                                '<td>' + result[i].itemname + '</td>' +
                                '<td>' + result[i].mstatus + '</td>' +
                                '<td><a class="data-content"  style="cursor:pointer; color:blue;">상세</a></td>' +
                                '<td><a class="datadelete"  style="cursor:pointer; color:red;">삭제</a></td>' +
                                '</tr>'
                            );
                        }
                    }
                }
            });
        }


        function rowcount() {
            var today = new Date();
            var year = today.getFullYear(); // 연도
            var month = today.getMonth() + 1; // 월 (0부터 시작하므로 1을 더해줍니다)
            var day = today.getDate(); // 일

            // 월과 일이 한 자리 숫자인 경우 두 자리로 만들어줍니다 (예: 2023-10-28)
            if (month < 10) {
                month = '0' + month;
            }

            if (day < 10) {
                day = '0' + day;
            }

            var currentDate = year + '-' + month + '-' + day;
            console.log(currentDate)

            const $table = document.getElementById('POdatatable-content2'); // table 엘리먼트 취득
            const trGroup = Array.from(document.querySelectorAll('#POdatatable-content2 tr'));

            const textGroup = trGroup.map(tr => {
                return Array.from(tr.children).map(input => input.textContent);
            });

            console.log(textGroup[2][0])
            console.log(textGroup[3][0])
            console.log($table.rows.length)
        }
    </script>


</body>

</html>