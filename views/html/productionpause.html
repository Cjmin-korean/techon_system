<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>거래처정보</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../css/main.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<style>
    #datatable-container {
        max-height: 1000px;
        /* Adjust the maximum height as needed */
        overflow-y: auto;
        /* Add vertical scrollbars if the content exceeds the container height */
    }

    #datatable {
        width: 100%;
        /* Other table styles */
    }
</style>

<body>
    <div class="main_header">
        <a>생산타발이력</a>
        <div class="buttons" style="display: flex; justify-content: flex-end;">
            <!-- <button >신규</button> -->
        </div>

    </div>
    <div id="loadingOverlay">
        <img src="/img/테크온로고.PNG" alt="로딩 이미지" class="loadingImage">

    </div>

    <!-- <div id="result-container">
        <h2>데이터 분석 결과</h2>
        <p id="pauseTime"></p>
        <p id="operatingTime"></p>
        <p id="totalStops"></p>
        <p id="totalRows"></p>
    </div> -->
    <div id="datatable-container">

        <table class="styled-table" id="datatable">
            <thead>
                <tr>
                    <th style="width: auto;" onclick="sortTable(0)">작업날짜</th>
                    <th style="width: auto;" onclick="sortTable(1)">작업지시번호</th>
                    <th style="width: auto;" onclick="sortTable(2)">LOTNO.</th>
                    <th style="width: auto;" onclick="sortTable(3)">BOMNO.</th>
                    <th style="width: auto;" onclick="sortTable(4)">모델명</th>
                    <th style="width: auto;" onclick="sortTable(5)">품명</th>
                    <th style="width: auto;" onclick="sortTable(6)">설비호기</th>
                    <th style="width: auto;" onclick="sortTable(7)">정지시간</th>
                    <th style="width: auto;" onclick="sortTable(8)">해제시간</th>
                    <th style="width: auto;" onclick="sortTable(9)">정지(초)</th>
                    <th style="width: auto;" onclick="sortTable(10)">원인</th>
                    <th style="width:80px;"></th>
                    <th style="width:80px;"></th>
                </tr>
            </thead>
            <tbody id="Datatbody">
            </tbody>
            <tfoot>
                <tr>
                    <td style="border: 1px solid silver;" colspan="12" id="dataCount"></td>
                </tr>
            </tfoot>
        </table>

    </div>
    <!-- 등록창 -->
    <div id="popupOverlay" style="display: none;">
        <div id="popupContent">
            <div class="form-group">
                <table style="width:100%;">
                    <tr>
                        <td colspan="2" class="popup_title">거래처 정보 추가</td>
                    </tr>
                    <tr>
                        <td style="width: 200px">거래처코드</td>
                        <td><input type="text" id="accountcode-save" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">사업자등록번호</td>
                        <td><input type="text" id="number-save" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">거래처명</td>
                        <td><input type="text" id="accountname-save" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">대표자명</td>
                        <td><input type="text" id="representativename-save" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">전화번호</td>
                        <td><input type="text" id="phone-save" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">Fax</td>
                        <td><input type="text" id="fax-save" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">모바일</td>
                        <td><input type="text" id="mobile-save" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">E-mail</td>
                        <td><input type="text" id="email-save" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">주소</td>
                        <td><input type="text" id="adress-save" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">기타</td>
                        <td><input type="text" id="etc-save" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                </table>
            </div>
            <button id="popupCloseBtn-save-close">취소</button>
            <button id="popupCloseBtn-save" onclick="Datasave()">저장</button>
        </div>
    </div>

    <!-- 수정창 -->
    <div id="popupOverlay1" style="display: none;">
        <div id="popupContent1" style="width: 700px; height: auto;">
            <div class="form-group">
                <table style="width:100%;">
                    <tr>
                        <td style="background-color: black; color: white;">거래처 정보 수정</td>
                        <td style="visibility: hidden;"><input type="text" id="id-edit" class="data" autocomplete="off"
                                style="width:100%; border:1px solid silver; "></td>

                    </tr>
                    <tr>
                        <td style="width: 200px">거래처코드</td>
                        <td><input type="text" id="accountcode-edit" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">사업자등록번호</td>
                        <td><input type="text" id="number-edit" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">거래처명</td>
                        <td><input type="text" id="accountname-edit" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">대표자명</td>
                        <td><input type="text" id="representativename-edit" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">전화번호</td>
                        <td><input type="text" id="phone-edit" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">Fax</td>
                        <td><input type="text" id="fax-edit" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">모바일</td>
                        <td><input type="text" id="mobile-edit" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">E-mail</td>
                        <td><input type="text" id="email-edit" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">주소</td>
                        <td><input type="text" id="adress-edit" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>
                    <tr>
                        <td style="width: 200px">기타</td>
                        <td><input type="text" id="etc-edit" class="data" autocomplete="off"
                                style="width:auto; border:1px solid silver;"></td>
                    </tr>

                </table>
            </div>
            <button id="popupCloseBtn-edit-close">취소</button>
            <button id="popupCloseBtn-edit" onclick="Dataedit()">수정</button>
        </div>
    </div>


    <!-- 삭제창 -->
    <div id="popupOverlay2" style="display: none;">
        <div id="popupContent2" style="width: 700px; height: auto;">
            <div class="form-group">
                <table style="width:100%;">
                    <tr>
                        <td style="background-color: black; color: white; width: 200px;">거래처 정보 삭제</td>
                        <td style="visibility: hidden;"><input type="text" id="id-edit" class="data" autocomplete="off"
                                style="width:100%; border:1px solid silver; "></td>

                    </tr>
                    <tr>
                        <td colspan="2" class="popup_title">거래처 정보를 삭제하시겠습니까?</td>
                    </tr>

                </table>
            </div>
            <button id="popupCloseBtn-delete-close">취소</button>
            <button id="popupCloseBtn-delete" onclick="Datadelte()">삭제</button>
        </div>
    </div>

    <script>
        var server = '';

        if (window.location.hostname == 'localhost') {
            server = 'http://localhost:8080';
        } else {
            server = 'http://techonmes.co.kr';
        }
        $(document).ready(function () {
            showLoading()
            load()

            $('#datatable').on('click', '.data-edit', function () {
                var str = "";
                var tdArr = new Array();// 배열 선언            
                var checkBtn = $(this);

                var tr = checkBtn.parent().parent();
                var td = tr.children();

                var accountcode = td.eq(0).text();
                var number = td.eq(1).text();
                var accountname = td.eq(2).text();
                var representativename = td.eq(3).text();
                var phone = td.eq(4).text();
                var fax = td.eq(5).text();
                var mobile = td.eq(6).text();
                var email = td.eq(7).text();
                var adress = td.eq(8).text();
                var etc = td.eq(9).text();
                var id = td.eq(12).text();
                $('#accountcode-edit').val(accountcode)
                $('#accountname-edit').val(accountname)
                $('#representativename-edit').val(representativename)
                $('#phone-edit').val(phone)
                $('#adress-edit').val(adress)
                $('#number-edit').val(number)
                $('#mobile-edit').val(mobile)
                $('#fax-edit').val(fax)
                $('#email-edit').val(email)
                $('#adress-edit').val(adress)
                $('#etc-edit').val(etc)
                $('#id-edit').val(id)
                $('#popupOverlay1').fadeIn();
                $('#accountcode-edit').focus()

            });
            $('#datatable').on('click', '.data-delete', function () {
                var str = "";
                var tdArr = new Array();// 배열 선언            
                var checkBtn = $(this);

                var tr = checkBtn.parent().parent();
                var td = tr.children();


                var id = td.eq(12).text();
                $('#id-edit').val(id)
                $('#popupOverlay2').fadeIn();
            });


            $('#popupCloseBtn-save-close').click(function () {
                $('#popupOverlay').fadeOut();
            });
            $('#popupCloseBtn-edit-close').click(function () {
                $('#popupOverlay1').fadeOut();
            });
            $('#popupCloseBtn-delete-close').click(function () {
                $('#popupOverlay2').fadeOut();
            });


        });



        //오름차순 내림차순
        function sortTable(columnIndex) {
            var table, rows, switching, i, x, y, shouldSwitch, direction, switchcount = 0;
            table = document.getElementById("datatable");
            switching = true;
            direction = "asc"; // 기본 정렬 방향은 오름차순

            while (switching) {
                switching = false;
                rows = table.getElementsByTagName("tr");

                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("td")[columnIndex];
                    y = rows[i + 1].getElementsByTagName("td")[columnIndex];

                    if (direction == "asc") {
                        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                            shouldSwitch = true;
                            break;
                        }
                    } else if (direction == "desc") {
                        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                            shouldSwitch = true;
                            break;
                        }
                    }
                }

                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchcount++;
                } else {
                    if (switchcount == 0 && direction == "asc") {
                        direction = "desc";
                        switching = true;
                    }
                }
            }
        }

        //검색
        function search() {
            const searchInput = document.getElementById('myInput');
            const dataTable = document.getElementById('datatable');
            const tableRows = dataTable.getElementsByTagName('tr');
            const dataCountCell = document.getElementById('dataCount');

            searchInput.addEventListener('input', function () {
                const searchValue = this.value.toLowerCase();
                let count = 0;

                for (let i = 1; i < tableRows.length; i++) {
                    const rowData = tableRows[i].getElementsByTagName('td');
                    let found = false;

                    for (let j = 0; j < rowData.length; j++) {
                        const cellData = rowData[j].textContent.toLowerCase();

                        if (cellData.includes(searchValue)) {
                            found = true;
                            break;
                        }
                    }

                    if (found) {
                        tableRows[i].style.display = '';
                        count++;
                    } else {
                        tableRows[i].style.display = 'none';
                    }
                }

                dataCountCell.textContent = `검색 결과 개수: ${count - 1}`;
            });
        }

        function showLoading() {
            var loadingOverlay = document.getElementById("loadingOverlay");
            loadingOverlay.style.display = "flex";

            // 로딩 완료 후 일정 시간 후 로딩 창 숨기기 (테스트용)
            setTimeout(function () {
                loadingOverlay.style.display = "none";
            }, 1000);
        }

        function New() {
            $('#accountcode-save').val('')
            $('#accountname-save').val('')
            $('#representativename-save').val('')
            $('#phone-save').val('')
            $('#adress-save').val('')
            $('#popupOverlay').fadeIn();
            $('#accountcode-save').focus()

        }

        function Datasave() {
            if (confirm("고객사 정보를 등록 하시겠습니까??") == true) {


                var accountcode = $('#accountcode-save').val();
                var accountname = $('#accountname-save').val();
                var representativename = $('#representativename-save').val();
                var phone = $('#phone-save').val();
                var adress = $('#adress-save').val();
                var number = $('#number-save').val();
                var fax = $('#fax-save').val();
                var mobile = $('#mobile-save').val();
                var email = $('#email-save').val();
                var etc = $('#etc-save').val();

                $.ajax({
                    type: 'POST',
                    url: server + '/api/accountinfoinsertdata',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({

                        "accountcode": accountcode,
                        "accountname": accountname,
                        "representativename": representativename,
                        "phone": phone,
                        "adress": adress,
                        "number": number,
                        "fax": fax,
                        "mobile": mobile,
                        "email": email,
                        "etc": etc




                    }),
                    success: function (result) {


                    }
                })

                $('#popupOverlay').fadeOut();
                setTimeout(function () {
                    load()
                }, 50); // 3초 후에 알림을 사라지게 설정
                var notification = $('<div class="notification"><img src="/img/테크온로고.PNG" alt="Notification Icon"><span class="notification-message" style="color:navy;">거래처 등록 완료</span></div>');
                $('body').append(notification);
                setTimeout(function () {
                    notification.fadeOut(function () {
                        $(this).remove();
                    });
                }, 3000);
            } else {
                return false;
            }
        }

        function Dataedit() {
            if (confirm("고객사 정보를 수정 하시겠습니까??") == true) {

                $.ajax({
                    type: 'POST',
                    url: server + '/api/accountupdatedata',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({

                        id: $('#id-edit').val(),
                        accountcode: $('#accountcode-edit').val(),
                        accountname: $('#accountname-edit').val(),
                        representativename: $('#representativename-edit').val(),
                        phone: $('#phone-edit').val(),
                        adress: $('#adress-edit').val(),
                        number: $('#number-edit').val(),
                        mobile: $('#mobile-edit').val(),
                        fax: $('#fax-edit').val(),
                        email: $('#email-edit').val(),
                        etc: $('#etc-edit').val()




                    }),
                    success: function (result) {
                        console.log(result)
                    }
                })

                $('#popupOverlay1').fadeOut();
                setTimeout(function () {
                    load()
                }, 50); // 3초 후에 알림을 사라지게 설정
                var notification = $('<div class="notification"><img src="/img/테크온로고.PNG" alt="Notification Icon"><span class="notification-message" style="color:navy;">거래처 수정 완료</span></div>');
                $('body').append(notification);
                setTimeout(function () {
                    notification.fadeOut(function () {
                        $(this).remove();
                    });
                }, 3000);
            } else {
                return false;
            }
        }


        function Datadelte() {
            if (confirm("고객사 정보를 삭제 하시겠습니까??") == true) {
                $.ajax({
                    type: 'POST',
                    url: server + '/api/accountinfodeletedata',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({

                        id: $('#id-edit').val(),

                    }),
                    success: function (result) {
                    }

                })
                $('#popupOverlay2').fadeOut();
                setTimeout(function () {
                    load()
                }, 50); // 3초 후에 알림을 사라지게 설정
                var notification = $('<div class="notification"><img src="/img/테크온로고.PNG" alt="Notification Icon"><span class="notification-message" style="color:navy;">거래처 삭제 완료</span></div>');
                $('body').append(notification);
                setTimeout(function () {
                    notification.fadeOut(function () {
                        $(this).remove();
                    });
                }, 3000);
            } else {
                return false;
            }





        }
        // function load() {
        //     $('#Datatbody').empty()
        //     $.ajax({
        //         type: 'POST',
        //         url: server + '/api/productionpause',
        //         dataType: 'json',
        //         success: function (data) {
        //             var tableFoot = $('#dataCount');
        //             if (data.length === 0) {
        //                 // 데이터가 없을 때 "데이터가 없습니다" 문구 추가
        //                 tableFoot.text('총 데이터 개수: 0');
        //             } else {
        //                 for (var i = 0; i < data.length; i++) {

        //                     $('#datatable').append(
        //                         '<tr>' +
        //                         '<td>' + data[i].indate + '</td>' +
        //                         '<td>' + data[i].orderno + '</td>' +
        //                         '<td>' + data[i].lotno + '</td>' +
        //                         '<td>' + data[i].bomno + '</td>' +
        //                         '<td>' + data[i].modelname + '</td>' +
        //                         '<td>' + data[i].itemname + '</td>' +
        //                         '<td>' + data[i].marchine + '</td>' +
        //                         '<td>' + data[i].startime + '</td>' +
        //                         '<td>' + data[i].finaltime + '</td>' +
        //                         '<td>' + data[i].cause + '</td>' +
        //                         '<td><a class="data-edit" style="cursor:pointer; color:navy;">수정</a></td>' +
        //                         '<td><a class="data-delete"style="cursor:pointer; color:red;">삭제</a></td>' +
        //                         '<td id="data-id">' + data[i].id + '</td>' +
        //                         '</tr>'

        //                     )
        //                     $("td#data-id").hide();

        //                     tableFoot.text('총 데이터 개수: ' + data.length);
        //                 }
        //             }
        //         }


        //     })
        // }
        function load() {
            $('#Datatbody').empty();
            $.ajax({
                type: 'POST',
                url: server + '/api/productionpause',
                dataType: 'json',
                success: function (data) {
                    var tableFoot = $('#dataCount');
                    var totalPauseTime = calculateTotalPauseTime(data);
                    var operatingTime = calculateOperatingTime(data);

                    if (data.length === 0) {
                        // 데이터가 없을 때 "데이터가 없습니다" 문구 추가
                        tableFoot.text('총 데이터 개수: 0');
                    } else {
                        for (var i = 0; i < data.length; i++) {
                            // 두 시간의 차이를 계산합니다.
                            var startTime = (data[i].startime);
                            var finalTime = (data[i].finaltime);
                            var timeDifferenceInSeconds = calculateTimeDifferenceInSeconds(startTime, finalTime);

                            $('#datatable').append(
                                '<tr>' +
                                '<td>' + data[i].indate + '</td>' +
                                '<td>' + data[i].orderno + '</td>' +
                                '<td>' + data[i].lotno + '</td>' +
                                '<td>' + data[i].bomno + '</td>' +
                                '<td>' + data[i].modelname + '</td>' +
                                '<td>' + data[i].itemname + '</td>' +
                                '<td>' + data[i].marchine + '</td>' +
                                '<td>' + startTime + '</td>' +
                                '<td>' + finalTime + '</td>' +
                                '<td style="color:red;">' + timeDifferenceInSeconds + '초</td>' + // 시간 차이를 초로 표시
                                '<td>' + data[i].cause + '</td>' +
                                '<td><a class="data-edit" style="cursor:pointer; color:navy;">수정</a></td>' +
                                '<td><a class="data-delete"style="cursor:pointer; color:red;">삭제</a></td>' +
                                '<td id="data-id">' + data[i].id + '</td>' +
                                '</tr>'
                            );

                            $("td#data-id").hide();
                        }
                    }
                }
            });
        }
        // 두 시간을 나타내는 문자열을 받아와서 초 단위로 변환하는 함수
        // 두 시간을 나타내는 문자열을 받아와서 초 단위로 변환하는 함수
        function calculateTimeDifferenceInSeconds(startTime, finalTime) {
            const startTimeParts = startTime.split(':');
            const finalTimeParts = finalTime.split(':');

            const startHours = parseInt(startTimeParts[0], 10);
            const startMinutes = parseInt(startTimeParts[1], 10);
            const startSeconds = parseInt(startTimeParts[2], 10);

            const finalHours = parseInt(finalTimeParts[0], 10);
            const finalMinutes = parseInt(finalTimeParts[1], 10);
            const finalSeconds = parseInt(finalTimeParts[2], 10);

            // 시작 시간과 종료 시간의 차이를 초로 계산
            const startInSeconds = startHours * 3600 + startMinutes * 60 + startSeconds;
            const finalInSeconds = finalHours * 3600 + finalMinutes * 60 + finalSeconds;
            const timeDifferenceInSeconds = finalInSeconds - startInSeconds;

            return timeDifferenceInSeconds;
        }
        function timeStringToSeconds(timeString) {
            const timeParts = timeString.split(':');
            const hours = parseInt(timeParts[0], 10);
            const minutes = parseInt(timeParts[1], 10);
            const seconds = parseInt(timeParts[2], 10);
            const totalSeconds = hours * 3600 + minutes * 60 + seconds;
            return totalSeconds;
        }

        function calculateTotalPauseTime(data) {
            var totalPauseTime = 0;

            for (var i = 0; i < data.length; i++) {
                // data[i]에서 정지시간을 추출하여 totalPauseTime에 더해준다
                totalPauseTime += parseInt(data[i].pauseDuration);
            }

            return totalPauseTime;
        }

        function calculateOperatingTime(data) {
            var operatingTime = 0;
            var workingStartTime = 9 * 60; // 9:00를 분으로 변환
            var workingEndTime = 18 * 60; // 18:00를 분으로 변환

            for (var i = 0; i < data.length; i++) {
                // data[i]에서 가동시간을 추출하여 workingStartTime과 workingEndTime 사이에 포함되는 경우 operatingTime에 더해준다
                var startTime = parseInt(data[i].startTime);
                var endTime = parseInt(data[i].endTime);

                if (startTime >= workingStartTime && endTime <= workingEndTime) {
                    operatingTime += endTime - startTime;
                } else if (startTime < workingStartTime && endTime > workingStartTime) {
                    operatingTime += endTime - workingStartTime;
                } else if (startTime < workingEndTime && endTime > workingEndTime) {
                    operatingTime += workingEndTime - startTime;
                }
            }

            return operatingTime;
        }

    </script>
</body>

</html>