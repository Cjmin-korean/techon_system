<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link rel="stylesheet" href="../css/shipmentplan1.css">
    <link rel="stylesheet" href="../css/spiner.css">

    <title>출하계획 대비 완제품 과부족 현황</title>

</head>

<body>

    <h2 style="margin-left: 20px;">* 출하계획 대비 완제품 과부족 현황</h2>
    <!-- <input type="date"> -->

    <div class="spinner-overlay">
        <div class="spinner"></div>
    </div>
    <table id="businessPlan">
        <thead>

        </thead>
        <tbody>
            <!-- 여기에 선택된 연도와 월에 따라 자바스크립트로 추가될 예정입니다. -->
        </tbody>
    </table>

    <script>
        var server = '';
        var gridApi;
        // console.log(window.location.hostname)
        if (window.location.hostname == 'localhost') {
            server = 'http://localhost:8080';
        } else {
            server = 'http://techonmes.co.kr';
        }

        $(document).ready(function () {
            var spinnerOverlay = document.querySelector('.spinner-overlay');
            spinnerOverlay.style.display = 'flex'; // Spiner 표시

            updateBusinessPlan();
            setTimeout(function () {
                spinnerOverlay.style.display = 'none'; // 1초 후에 Spiner 숨김
            }, 1100);
        });



        var yearSelect = document.getElementById('yearSelect');
        var monthSelect = document.getElementById('monthSelect');
        var businessPlanTable = document.getElementById('businessPlan').getElementsByTagName('tbody')[0];

        // 년도 옵션 생성
        var currentYear = new Date().getFullYear();
        for (var i = currentYear; i >= currentYear - 2; i--) {
            var option = document.createElement('option');
            option.value = i;
            option.textContent = i + '년';
            yearSelect.appendChild(option);
        }

        yearSelect.addEventListener('change', updateBusinessPlan);
        monthSelect.addEventListener('change', updateBusinessPlan);

        function updateBusinessPlan() {
            var today = new Date();
            var year = today.getFullYear();
            var month = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 1을 더해준다.
            var day = String(today.getDate()).padStart(2, '0'); // 일

            // 20일 뒤의 날짜 구하기
            var futureDate = new Date(today);
            futureDate.setDate(futureDate.getDate() + 20);
            var futureYear = futureDate.getFullYear();
            var futureMonth = String(futureDate.getMonth() + 1).padStart(2, '0');
            var futureDay = String(futureDate.getDate()).padStart(2, '0');

            // 테이블 헤더 업데이트
            var tableHeader = '<tr><th style="width:100px;">모델명</th><th style="width:100px;">제품명</th><th style="width:150px;">구분</th><th style="width:100px;">자공정재고</th><th style="width:100px;">앞공정재고</th>';
            for (var currentDate = new Date(today); currentDate <= futureDate; currentDate.setDate(currentDate.getDate() + 1)) {
                var currentYear = currentDate.getFullYear();
                var currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                var currentDay = String(currentDate.getDate()).padStart(2, '0');
                var date = currentMonth + '/' + currentDay;
                tableHeader += '<th class="date">' + date + '</th>';
            }
            tableHeader += '</tr>';
            businessPlanTable.innerHTML = tableHeader;






            $.ajax({
                type: 'POST',
                url: server + '/api/deficiency',
                dataType: 'json',
                success: function (data) {
                    var tableBody = '';
                    data.forEach(function (item) {
                        // itemname이 rowspan3이 되도록 추가
                        tableBody += '<tr>';
                        tableBody += '<td rowspan="7">' + item.modelname + '</td>';
                        tableBody += '<td rowspan="7">' + item.itemname + '</td>';
                        tableBody += '<td>납품계획</td>';
                        tableBody += '<td colspan="2" style="background-color:lightblue;">' + item.sumquantity.toLocaleString() + '</td>';

                        // 각 일자별로 편집 가능한 셀 추가
                        for (var currentDate = new Date(today); currentDate <= futureDate; currentDate.setDate(currentDate.getDate() + 1)) {
                            var currentYear = currentDate.getFullYear();
                            var currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                            var currentDay = String(currentDate.getDate()).padStart(2, '0');
                            var date = currentMonth + '-' + currentDay;
                            tableBody += '<td id="shipment-' + item.bomno + '-' + currentYear + '-' + date + '"></td>';
                        }
                        tableBody += '</tr>';
                        $.ajax({
                            type: 'POST',
                            url: server + '/api/deficiencyshipmentplan',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify({

                            }),
                            success: function (result) {

                                for (var i = 0; i < result.length; i++) {
                                    $('#shipment-' + item.bomno + '-' + result[i].shipmentdate).text(result[i].quantity.toLocaleString());
                                }
                            },

                        });

                        tableBody += '<tr>';
                        tableBody += '<td>생산</td>';
                        tableBody += '<td id="productquantity"></td>';
                        tableBody += '<td>60,000</td>';

                        // 각 일자별로 편집 가능한 셀 추가
                        for (var currentDate = new Date(today); currentDate <= futureDate; currentDate.setDate(currentDate.getDate() + 1)) {
                            var currentYear = currentDate.getFullYear();
                            var currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                            var currentDay = String(currentDate.getDate()).padStart(2, '0');
                            var date = currentMonth + '-' + currentDay;
                            tableBody += '<td id="product-' + item.bomno + '-' + currentYear + '-' + date + '"></td>';
                        }

                        $.ajax({
                            type: 'POST',
                            url: server + '/api/deficiencyproduct',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify({

                            }),
                            success: function (result) {

                                for (var i = 0; i < result.length; i++) {
                                    $('#productquantity').text(result[0].quantity.toLocaleString());
                                }
                            },

                        });

                        tableBody += '</tr>';

                        var minusProductValue = (parseFloat(30000) - parseFloat(item.sumquantity)).toLocaleString();
                        var minusProductStyle = '';
                        // if (minusProductValue < 0) {
                        //     // 값이 음수인 경우 빨간색으로 표시
                        //     minusProductStyle = 'color: red;';
                        // }

                        tableBody += '<tr>';
                        tableBody += '<td style="color:red;">과부족(생산)</td>';

                        tableBody += '<td style="color:red" id="minusproduct">' + minusProductValue + '</td>';
                        tableBody += '<td style="color:red;">-40,000</td>';
                        tableBody += '<td></td>';

                        // 각 일자별로 편집 가능한 셀 추가
                        for (var currentDate = new Date(today); currentDate <= futureDate; currentDate.setDate(currentDate.getDate() + 1)) {
                            var currentYear = currentDate.getFullYear();
                            var currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                            var currentDay = String(currentDate.getDate()).padStart(2, '0');
                            var date = currentMonth + '-' + currentDay;
                            tableBody += '<td id="minusproduct-' + item.bomno + '-' + currentYear + '-' + date + '"></td>';
                        }
                        tableBody += '</tr>';

                        tableBody += '<tr>';
                        tableBody += '<td>검사</td>';
                        tableBody += '<td>20,000</td>';
                        tableBody += '<td>40,000</td>';

                        // 각 일자별로 편집 가능한 셀 추가
                        for (var currentDate = new Date(today); currentDate <= futureDate; currentDate.setDate(currentDate.getDate() + 1)) {
                            var currentYear = currentDate.getFullYear();
                            var currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                            var currentDay = String(currentDate.getDate()).padStart(2, '0');
                            var date = currentMonth + '-' + currentDay;
                            tableBody += '<td id="inspection-' + item.bomno + '-' + currentYear + '-' + date + '"></td>';
                        }
                        tableBody += '</tr>';

                        tableBody += '<tr>';
                        tableBody += '<td style="color:red;">과부족(검사)</td>';

                        tableBody += '<td style="color:red;">-80,000</td>';
                        tableBody += '<td style="color:red;">-60,000</td>';
                        tableBody += '<td></td>';

                        // 각 일자별로 편집 가능한 셀 추가
                        for (var currentDate = new Date(today); currentDate <= futureDate; currentDate.setDate(currentDate.getDate() + 1)) {
                            var currentYear = currentDate.getFullYear();
                            var currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                            var currentDay = String(currentDate.getDate()).padStart(2, '0');
                            var date = currentMonth + '-' + currentDay;
                            tableBody += '<td id="minusinspection-' + item.bomno + '-' + currentYear + '-' + date + '"></td>';
                        }

                        tableBody += '</tr>';

                        tableBody += '<tr>';
                        tableBody += '<td>완제품</td>';

                        tableBody += '<td>40,000</td>';
                        tableBody += '<td>-</td>';

                        // 각 일자별로 편집 가능한 셀 추가
                        for (var currentDate = new Date(today); currentDate <= futureDate; currentDate.setDate(currentDate.getDate() + 1)) {
                            var currentYear = currentDate.getFullYear();
                            var currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                            var currentDay = String(currentDate.getDate()).padStart(2, '0');
                            var date = currentMonth + '-' + currentDay;
                            tableBody += '<td id="item-' + item.bomno + '-' + currentYear + '-' + date + '"></td>';
                        }
                        tableBody += '</tr>';

                        tableBody += '<tr>';
                        tableBody += '<td style="color:red;">과부족(완제품)</td>';

                        tableBody += '<td style="color:red;">-60,000</td>';
                        tableBody += '<td></td>';
                        tableBody += '<td></td>';

                        // 각 일자별로 편집 가능한 셀 추가
                        for (var currentDate = new Date(today); currentDate <= futureDate; currentDate.setDate(currentDate.getDate() + 1)) {
                            var currentYear = currentDate.getFullYear();
                            var currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                            var currentDay = String(currentDate.getDate()).padStart(2, '0');
                            var date = currentMonth + '-' + currentDay;
                            tableBody += '<td id="minusitem-' + item.bomno + '-' + currentYear + '-' + date + '"></td>';
                        }
                    });


                    businessPlanTable.innerHTML += tableBody;
                },
            });


            // deficiencyshipmentplan
            // 클릭 이벤트를 추가할 TD 요소를 찾습니다.



        }





    </script>

</body>

</html>