<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/sales.css">
    <link rel="stylesheet" href="/css/accountinformation.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/buttons/2.0.1/css/buttons.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.4/css/select.dataTables.min.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript"
        src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/select/1.3.4/js/dataTables.select.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.colVis.min.js"></script>

    




 



</head>

<body>

    <div class="popup" id="pop1">

        <a class="popup_title">수량입력</a>

        <div class="popup-up">
            <input type="button" class="close_button" value="닫기" onclick="modalClose()">
            <input type="button" class="save_button" value="저장" onclick="tableadd()">
        </div>

        <hr>
        <div class="popupcontent" style="width: 100%">
            <a>BOM NO. : </a><br>
            <input type="text" style="width: 300px; height: 30px; " id="bomno"><br>

            <a>모델명 : </a><br>
            <input type="text" style="width: 300px; height: 30px;" id="modelname"><br>

            <a>제품명 : </a><br>
            <input type="text" style="width: 300px; height: 30px;" id="itemname"><br>

            <a>규격 : </a><br>
            <input type="text" style="width: 300px; height: 30px;" id="size"><br>

            <a>단가 : </a><br>
            <input type="text" style="width: 300px; height: 30px;" id="itemprice"><br>

            <a>수량 : </a><br>
            <input type="text" style="width: 300px; height: 30px;" id="count" onchange="valuechange()"
                onkeyup="inputNumberFormat(this)">
        </div>



    </div>

    <div class="title" style="border: 1px solid black;">
        <h3 class="title-htag" style="margin-left:20px;"> 영업수주등록 </h3>
        <button class="account_save" onclick="save_open()">저장</button>
    </div>

    <div style="width:100%; height:50px; border: 1px solid black;">

        <a style="float:left; margin-top:15px; margin-left:10px;">거래처:</a>
        <input type="text" id="accountname"
            style="float:left; margin-top:15px; margin-left:10px; width: 200px; height: 22px;">
        <button onclick="removerow()">검색</button>

        <a style="float:left; margin-top:15px; margin-left:10px;">납기일자:</a>
        <input class="input_date" type="date" id="datepicker2"
            style="float:left; margin-top:15px; margin-left:10px; width: 200px; height: 22px;">
    </div>

    <div class="pop_content" id="pop2" style="width:50%; float: left;">
        <div class="bomleft" style="width:100%; height: 300px; ">
            <table id="fileinfo" class="display" style="width:100%; ">
                <thead>
                    <tr>
                        <th></th>
                        <th>BOM NO.</th>
                        <th>모델명</th>
                        <th>제품명</th>
                        <th>규격</th>
                        <th>단가</th>
                        <th></th>

                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>


    </div>

    <div class="pop_content" id="pop2" style="width:47%; margin-top: 30px; float :right;">
        <div class="title" style="border: 1px solid black;">
            <h3 class="title-htag" style="margin-left:20px;"> 영업수주등록 </h3>

        </div>
        <div class="bomleft" style="width:100%; height: 300px; ">
            <table id='myTable' class="sales-table">
                <thead>
                    <tr>


                        <th style="width: 250px;">모델명</th>
                        <th style="width: 250px">제품명</th>
                        <th style="width: 80px;">제품단가(₩)</th>
                        <th style="width: 60px;">수량(개)</th>
                        <th style="width: 60px;">금액(₩)</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody class="table_first" id="accounttable">

                </tbody>
            </table>

        </div>


    </div>

</body>




<script>

    var table;
    $.ajax({
        type: 'POST',
        url: "http://localhost:8080/api/iteminfo"
    }).done(function (d) {
        settingDate()
        table = $('#fileinfo').DataTable({
            data: d,
            lengthMenu: [8, 10],
            // dom: 'Bfrtip',


            "columns": [

                { "data": "id" },
                { "data": "bomno" },
                { "data": "modelname" },
                { "data": "itemname" },
                { "data": "size" },
                { "data": "itemprice" }

            ],
            columnDefs: [

                {
                    targets: 0,
                    visible: false
                },

                {
                    targets: 6,
                  
                    defaultContent: '<button>추가</button>',
                    width: 70
                }

            ],
            destroy: true, // 이 부분 체크해 주세요!

            //언어 변경
            "language": {
                emptyTable: "데이터가 없습니다.",
                lengthMenu: "페이지당 _MENU_ 개씩 보기",
                info: "현재 _START_ - _END_ / _TOTAL_건",
                infoEmpty: "데이터 없음",
                infoFiltered: "( _MAX_건의 데이터에서 필터링됨 )",
                search: "검색:",
                zeroRecords: "일치하는 데이터가 없습니다.",
                loadingRecords: "로딩중...",
                processing: "잠시만 기다려 주세요.",
                paginate: {
                    next: "다음",
                    previous: "이전",
                },
            },

        }
        );
    });
    $('#fileinfo tbody').on('click', 'button', function () {
        table1 = $('#fileinfo').DataTable();
        var data1 = table1.row($(this).parents('tr')).data(); // getting 

        $('#bomno').val(data1.bomno);
        $('#size').val(data1.size);
        $('#modelname').val(data1.modelname);
        $('#itemname').val(data1.itemname);
        $('#itemprice').val(data1.itemprice);
        $('.popup').css("display", "block");

    });

    function modalClose() {
        $('.popup').css("display", "none");
    }

    function tableadd() {

        modelname = $('#modelname').val();
        itemname = $('#itemname').val();

        itemprice = $('#itemprice').val();
        itemcount = $('#count').val();
        var number = itemcount.replace(/,/g, "");
        price = number * $('#itemprice').val();

        const table = document.getElementById('myTable');
        const totalRowCnt = table.rows.length;
        var count = totalRowCnt;

        $('.table_first').append(
            '<tr>' +
            '<td><input type="text" class="tdTextStyle" id="row_modelname' + count + '" value="' + modelname + '"></td>' +
            '<td><input type="text" class="tdTextStyle" id="row_itemname' + count + '" value="' + itemname + '"></td>' +

            '<td><input type="text" class="tdTextStyle" style="text-align: right" id="row_itemprice' + count + '" value="' + itemprice + '"></td>' +
            '<td><input type="text" class="tdTextStyle" style="text-align: right" id="row_itemcount' + count + '" value="' + itemcount + '"></td>' +
            '<td><input type="text" class="tdTextStyle" style="text-align: right" id="row_price' + count + '" value="' + price + '"></td>' +
            '<td><input type="button" onclick="deleteRow()" value="삭제">' +
            '</tr>'
        )


        $('#count').val('');

        $('.popup').css("display", "none");
    }


    function deleteRow(row) {
        var d = row.parentNode.parentNode.rowIndex;
        document.getElementById('table_first').deleteRow(d);
    }


    // 숫자 컴마표시
    function inputNumberFormat(obj) {
        obj.value = comma(uncomma(obj.value));
    }
    // 숫자 컴마 제거후 int 변경
    function comma(str) {
        str = String(str);
        return str.replace(/(\d)(?=(?:\d{3})+(?!\d))/g, '$1,');
    }
    function uncomma(str) {
        str = String(str);
        return str.replace(/[^\d]+/g, '');
    }
    ///////=====================

    function valuechange() {
        const table = document.getElementById('myTable');
        const totalRowCnt = table.rows.length;

        // result.innerText = '전체 행 개수: ' + totalRowCnt + '\n'

        var count = totalRowCnt;
        var addcount = count - 1;
        for (var i = 1; i < addcount; i++) {
            var itemprice = $('#row_itemprice' + i + '').val();
            var quantity = $('#row_quantity' + i + '').val()
            var number1 = itemprice.replace(/,/g, "");
            var number = quantity.replace(/,/g, "");

            $('#row_price' + i + '').val(number1 * number)
        }

    }

    function save_open() {
        if ($('#accountname').val() === '') {

            alert("거래처가 누락되었습니다.");
            return
        }

        // if ($('.input_customer').val() === '') {

        //     alert("거래처가 누락되었습니다.");
        //     return
        // }

        // var deliverydate = $('#datepicker2').val();

        if (confirm("납기일 :" + $('#datepicker2').val() + " 영업 수주 정보를 등록 하시겠습니까??") == true) {



            const table = document.getElementById('myTable');
            const totalRowCnt = table.rows.length;



            var count = totalRowCnt;
            var addcount = count ;
            var addcount1 = count - 3;

            for (var i = 1; i < addcount; i++) {

                var accountdate = $('#datepicker2').val();
                var customer = $('#accountname').val();
                var modelname = $('#row_modelname' + i + '').val();
                var itemname = $('#row_itemname' + i + '').val();
                var itemprice = $('#row_itemprice' + i + '').val();
                var quantity = $('#row_itemcount' + i + '').val()
                var number2 = quantity.replace(/,/g, "");
                var price = $('#row_price' + i + '').val();
                var number3 = price.replace(/,/g, "");

                $.ajax({
                    type: 'POST',
                    url: 'http://localhost:8080/api/openinsertdata',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        "accountdate": accountdate,
                        "deliverydate": accountdate,
                        "customer": customer,
                        "modelname": modelname,
                        "itemname": itemname,
                        "itemprice": itemprice,
                        "quantity": number2,
                        "price": number3


                    }),
                    success: function (result) {
                        console.log(result)
                    }
                })

            }


            alert("저장이 완료 되었습니다.");

            $('.table_first').empty();




        } else {
            return false;
        }


    }

    function settingDate() {
        const date = new Date();

        var day = date.getDate();
        var month = date.getMonth() + 1;
        var year = date.getFullYear();

        console.log((month).length, day.length)

        if (month === 1 || month === 2 || month === 3 || month === 4 || month === 5 || month === 6 || month === 7 || month === 8 || month === 9) {
            month = '0' + month
            console.log(month)
        }

        if (day === 1 || day === 2 || day === 3 || day === 4 || day === 5 || day === 6 || day === 7 || day === 8 || day === 9) {
            day = '0' + day
            console.log(day)
        }


        // This arrangement can be altered based on how we want the date's format to appear.
        let currentDate = `${year}-${month}-${day}`;
        console.log(currentDate); // "17-6-2022"


        $('#datepicker2').val(currentDate);

    }
    function accuountsave() {
        $('.table_first').empty();
    }
</script>

</html>