<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수입검사완료현황</title>
    <script src="../assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="../assets/js/core/popper.min.js"></script>
    <script src="../assets/js/core/bootstrap.min.js"></script>
    <script src="../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="../assets/js/plugin/datatables/datatables.min.js"></script>
    <script src="../assets/js/kaiadmin.min.js"></script>
    <script src="../assets/js/setting-demo2.js"></script>
    <script src="../assets/js/plugin/webfont/webfont.min.js"></script>
    <script src="../js/bommasssave.js"></script>
    <script src="../js/bommass.js"></script>
    <script src="../js/bomsave.js"></script>
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../assets/css/plugins.min.css" />
    <link rel="stylesheet" href="../assets/css/kaiadmin.min.css" />
    <link rel="stylesheet" href="../assets/css/demo.css" />
    <link rel="stylesheet" href="../assets/css/demo1.css" />
</head>
<style>
    input[type="text"],
    select {
        font-family: Arial, sans-serif;
        font-size: 14px;
        text-align: right;
    }

    .modal-body {
        max-height: calc(100vh - 100px);
        /* Adjust based on your modal header/footer height */
        /* overflow-y: auto; */
    }

    #containers {
        height: 90%;
        /* overflow-y: auto; */
        display: block;
    }

    .table-container {
        width: 100%;
        height: 700px;
        /* Adjust the height as needed */
        overflow-y: auto;
        border: 1px solid #ccc;
    }
</style>

<body>

    <div class="modal fade" id="newModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document" style="width: 150vh;">
            <div class="modal-content" style="height: 90vh;">
                <div class="modal-header">
                    <h5 class="modal-title">자재검색</h5>
                    <input type="text" id="numericPart" style="width: 50px; visibility: hidden;">

                </div>
                <div class="modal-body" style="height: 100%;">

                    <div class="table-container">
                        <table class="table table-bordered">
                            <thead>
                                <th style="text-align: center;">자재검색</th>

                                <td colspan="10"><input class="styled-input" id="search-input"
                                        placeholder="검색어를 입력후 Enter키를 누르세요" style="text-align: left;" type="text"
                                        autocomplete="off">
                                </td>
                                <tr>
                                    <th>자재명</th>
                                    <th>자재폭(mm)</th>
                                    <th>길이(M)</th>
                                    <th>구매처</th>
                                    <th>자재종류</th>
                                    <th>NO</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="itemtbody1">
                                <tr id="no-search-row">
                                    <td colspan="11" style="text-align: center;">검색내용이 없습니다</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="searchingcloseButton" class="btn btn-danger"
                        data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width: 190vh;">
            <div class="modal-content" style=" height: 95vh;">
                <div class="modal-header" style="height: 70px;">
                    <h5 class="modal-title" id="productModalLabel">생산현장</h5>
                </div>
                <div class="modal-body">
                    <div class="container-fluid" style="margin-top: -20px;">
                        <!-- First table -->


                        <div class="col-md-6" style="height: auto; float: left;" id="tableContainer">
                            <table class="table-bordered" id="Podatatable">

                                <tr>
                                    <th colspan="5">생산준비</th>
                                </tr>
                                <tr>
                                    <th>구분</th>
                                    <th style="width: 100px;">QR CODE</th>
                                    <th>DATA</th>
                                    <th>확인</th>
                                    <th>RESET</th>
                                </tr>
                                <tr>
                                    <td><b>작업자</b></td>

                                    <td><select class="form-select" id="peopleInput">
                                            <option></option>

                                        </select></td>
                                    <td></td>
                                    <td></td>
                                    <td><button class="btn btn-success" id="startbtn">생산시작</button>
                                    </td>

                                </tr>
                                <tr>
                                    <td><b>작업지시서</b></td>
                                    <td><input type="text" id="textInputA" autocomplete="off"
                                            placeholder="작업지시서 QR CODE를 리딩하세요" value="" style="width: 500px;"></td>
                                    <td></td>
                                    <td></td>
                                    <td><button class="btn btn-primary" onclick="reseta()">RESET</button></td>

                                </tr>
                                <tr>
                                    <td><b>작업 설비1</b></td>
                                    <td><input type="text" id="textInputB" autocomplete="off"
                                            placeholder="설비 QR CODE를 리딩하세요" value="" style="width: 500px;"></td>
                                    <td id="e1"></td>
                                    <td id="r1"></td>
                                    <td><button class="btn btn-primary" onclick="resetb()">RESET</button></td>
                                </tr>
                                <tr>
                                    <td><b>작업 설비2</b></td>
                                    <td><input type="text" id="textInputC" autocomplete="off"
                                            placeholder="설비 QR CODE를 리딩하세요" value="" style="width: 500px;"></td>
                                    <td id="e2"></td>
                                    <td id="r2"></td>


                                    <td><button class="btn btn-primary" onclick="resetc()">RESET</button></td>
                                </tr>
                                <tr>
                                    <td><b>금형 코드1</b></td>
                                    <td><input type="text" id="textInputD" autocomplete="off"
                                            placeholder="금형 QR CODE를 리딩하세요" value="" style="width: 500px;"></td>
                                    <td id="m1"></td>
                                    <td id="r3"></td>
                                    <td><button class="btn btn-primary" onclick="resetd()">RESET</button></td>
                                </tr>
                                <tr>
                                    <td><b>금형 코드2</b></td>
                                    <td><input type="text" id="textInputE" autocomplete="off"
                                            placeholder="금형 QR CODE를 리딩하세요" value="" style="width: 500px;"></td>
                                    <td id="m2"></td>
                                    <td id="r4"></td>

                                    <td><button class="btn btn-primary" onclick="resete()">RESET</button></td>
                                </tr>
                            </table>
                            <table class="table-bordered" id="Podatatable1">

                                <tr>
                                    <th colspan="8" style="height: 50px;">생산 출고 자재 확인</th>
                                </tr>
                                <tr>
                                    <th>QR CODE</th>
                                    <td colspan="7"><input type="text" id="materialreading" placeholder="자재 QR을 리딩하세요"
                                            style="width: 90%;"></td>
                                </tr>
                                <tr>
                                    <th>자재명</th>
                                    <th>규격폭</th>
                                    <th>수량</th>
                                    <th>LOTNO</th>
                                    <th>롤수량</th>
                                    <th>총입고수량</th>
                                    <th>결과</th>
                                    <th>반납자재</th>
                                </tr>

                            </table>
                        </div>

                        <div class="col-md-6" style="height: auto; float: right;" id="tableContainer">
                            <div style="height: 30vh;">
                                <table class="table-bordered" id="Podatatable">

                                    <tr>
                                        <th colspan="7">생산정보</th>
                                    </tr>
                                    <tr class="table-light">
                                        <th>BOMNO</th>
                                        <th>모델명</th>
                                        <th>제품명</th>
                                        <th>고객사명</th>
                                        <th>생산수량</th>
                                        <th>작업차수</th>

                                    </tr>
                                    <tr class="table-light">
                                        <td id="bomno"></td>
                                        <td id="modelname"></td>
                                        <td id="itemname"></td>
                                        <td id="customer"></td>
                                        <td id="pono"></td>
                                        <td id="part"></td>
                                    </tr>
                                    <tr class="table-light">
                                        <th>Cavity</th>
                                        <th>PCS수량</th>
                                        <th>공정구분</th>
                                        <th>타발방향</th>
                                        <th>생산LOT</th>
                                        <th>고객사코드</th>

                                    </tr>
                                    <tr class="table-light">
                                        <td id="cavity"></td>
                                        <td id="pcs"></td>
                                        <td id="working"></td>
                                        <td id="direction"></td>
                                        <td id="lotno"></td>
                                        <td id="itemcode"></td>
                                    </tr>
                                    <tr class="table-light">
                                        <th colspan="3">완제품/반제품</th>
                                        <td colspan="3" id="producttype"></td>
                                    </tr>

                                </table>
                            </div>

                            <table class="table-bordered" id="Podatatable1">
                                <thead>
                                    <tr>
                                        <th colspan="7">생산결과</th>
                                    </tr>
                                    <tr>
                                        <th>생산시작</th>
                                        <td colspan="3" id="starttime"></td>
                                        <th>타발수</th>
                                        <td colspan="3"><input type="text" id="touchcount"></td>
                                    </tr>
                                    <tr class="table-light">
                                        <th colspan="7">비가동 내역</th>
                                    </tr>
                                    <tr>
                                        <th colspan="2">정지시간</th>
                                        <th colspan="2">정지해제시간</th>
                                        <th colspan="2">비가동 사유</th>
                                        <th style="width:100px;"><button onclick="save1()"
                                                class="btn btn-secondary">정지</button></th>
                                    </tr>
                                <tbody id="equipmenthistorytbody">

                                </tbody>
                                </thead>
                                <tbody id="materialinfo">


                                </tbody>

                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="savebtn" onclick="Bomsave()">생산종료</button>
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>




    <div class="page-inner">
        <div class="page-header">
            <div class="col-md-12">
                <div class="card">
                    <div class="page-inner">
                        <div class="card-header">
                            <div class="d-flex align-items-center">
                                <h4 class="card-title">생산 대기리스트</h4>

                            </div>
                            <div class="card-body">
                                <div class="date-input-group">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body" style="height: 70vh; max-height: 70vh; overflow-y: auto;">
                        <div style="margin-top: -10px;">
                            <table class="styled-table">
                                <thead id="tableHead">

                                    <tr>
                                        <th>BOMNO</th>
                                        <th>구분</th>
                                        <th>고객사</th>
                                        <th>모델명</th>
                                        <th>제품명</th>
                                        <th>고객사코드</th>
                                        <th>TYPE</th>
                                        <th>공정구분</th>
                                        <th>원가(￦)</th>
                                        <th>단가(￦)</th>
                                        <th>재료비(%)</th>
                                        <th>자재개수</th>
                                        <th style="width: 150px;"></th>
                                    </tr>

                                    </tr>
                                </thead>
                                <tbody id="Datatbody">
                                    <tr id="no-data-row">
                                        <td colspan="20" style="text-align: center;">데이터가 없습니다</td>
                                    </tr>
                                </tbody>
                                <tfoot id="iteminfofoot"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>


</body>

<script>
    var server = '';
    if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
        server = 'http://localhost:8080';
    } else {
        server = 'http://techonmes.co.kr';
    }
    $(document).on('click', '.add-btn', function () {
        const row = $(this).closest('tr'); // Get the closest row
        const itemname = row.find('td:nth-child(1)').text(); // Ensure correct index for itemname
        const width = row.find('td:nth-child(3)').text();
        const quantity = row.find('td:nth-child(4)').text();
        const length = row.find('td:nth-child(5)').text();
        const cut = row.find('td:nth-child(6)').text();
        const rollprice = row.find('td:nth-child(8)').text();
        const suppliername = row.find('td:nth-child(9)').text();

        const totalValue = (parseFloat(length) * parseFloat(quantity) * parseFloat(cut)).toFixed(0).toLocaleString();

        // Check if a row with the same itemname already exists in accountdatatbody2
        let exists = false;
        $('#accountdatatbody2 tr').each(function () {
            if ($(this).find('td:first').text() === itemname) {
                exists = true;
                return false; // Exit loop early
            }
        });

        // Remove the "데이터가 없습니다" row if it exists
        const noDataRow = $('#accountdatatbody2 #no-data-row2');
        if (noDataRow.length) {
            noDataRow.remove();
        }

        // Append the new row to accountdatatfoot2
        const newRow = `
    <tr>
        <td>${itemname}</td>
        <td><input type="text" style="text-align:right;" autocomplete="off" oninput="updateTotalValue();" value="${width}"></td>
        <td><input type="text" style="text-align:right;" autocomplete="off" oninput="updateTotalValue();" value="${quantity}" id="quantity"></td>
        <td><input type="text" style="text-align:right;" autocomplete="off" oninput="updateTotalValue();" value="${length}" id="length"></td>
        <td><input type="text" style="text-align:right;" autocomplete="off" readonly value="${cut}" id="cut"></td>
        <td id="totalValue">${totalValue}</td>
        <td><input type="text" style="text-align:right;" value=""></td>
        <td id="rollprice">${rollprice}</td>
        <td id="suppliername">${suppliername}</td>
    </tr>
    `;
        $('#accountdatatbody2').append(newRow);
    });



    $(document).ready(function () {
        $.ajax({
            type: 'POST',
            url: server + '/api/selectproductionpeople',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify({}),
            success: function (result) {

                var selectElement = document.getElementById('peopleInput');

                selectElement.innerHTML = '';

                var blankOption = document.createElement('option');
                blankOption.text = ''; // 공란 텍스트
                blankOption.value = ''; // 공란 값
                selectElement.appendChild(blankOption);
                result.forEach(function (person) {
                    var option = document.createElement('option');
                    option.text = person.people; // 예시 데이터에 따라 적절한 속성으로 변경
                    option.value = person.people; // 예시 데이터에 따라 적절한 속성1으로 변경
                    selectElement.appendChild(option);
                });
            }
        });
        $('#orderno').on('keydown', function (event) {
            if (event.key === 'Enter') {
                $.ajax({
                    type: 'POST',
                    url: server + '/api/ordernoselect',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        "orderno": $('#orderno').val()
                    }),
                    success: function (result) {
                        const tableBody = $('#accountdatatbody');
                        const tableFoot = $('#accountdatatfoot');
                        let totalSupplyAmount = 0; // To store the total supply amount

                        tableBody.empty();
                        tableFoot.empty(); // Clear the table footer

                        if (result.length === 0) {
                            tableBody.append('<tr><td colspan="8">구매발주 데이터가 없습니다.</td></tr>');
                            tableFoot.hide(); // Hide the tfoot element
                        } else {
                            for (let i = 0; i < result.length; i++) {
                                const item = result[i];
                                totalSupplyAmount += item.supplyamount; // Add to total

                                // Append row to table
                                const row = `
                            <tr>
                                <td>${item.itemname}</td>
                                <td>${item.materialwidth.toLocaleString()}</td>
                                <td>${item.width}</td>
                                <td>${item.quantity.toLocaleString()}</td>
                                <td>${item.length.toLocaleString()}</td>
                                <td>${item.cut}</td>
                                <td>${(parseFloat(item.length) * parseFloat(item.cut) * parseFloat(item.quantity)).toLocaleString()}</td>
                                <td>${item.supplyamount.toLocaleString()}</td>
                                <td>${item.suppliername}</td>
                                <td><button class="btn btn-success add-btn"  style="text-align:center; padding:10px;">추가</button></td>
                                <td class="data-id" style="display:none;">${item.id}</td>
                            </tr>
                        `;
                                tableBody.append(row);
                            }

                            // Append the total row to the tfoot
                            const tableFooter = `
                        <tr>
                            <td colspan="7" style="text-align:right;"><strong>합계</strong></td>
                            <td>${totalSupplyAmount.toLocaleString()}</td>
                            <td colspan="3"></td>
                        </tr>
                    `;
                            tableFoot.append(tableFooter);
                            tableFoot.show(); // Show the tfoot element
                        }

                        // Add click event listener to each add button



                    },
                });
            }
        });


        // Initialize DataTable with search functionality
        $('#orderdatatable thead input[type="checkbox"]').on('change', function () {
            var isChecked = $(this).prop('checked');

            $('#orderdatatable tbody input[type="checkbox"]').prop('checked', isChecked);

            if (isChecked) {
                // Get the IDs of checked checkboxes
                var checkedIds = $('#orderdatatable tbody input[type="checkbox"]:checked').map(function () {
                    return $(this).closest('tr').find('td#data-id').text();
                }).get();
            }
        });


        var today = new Date();

        var year = today.getFullYear();
        var month = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 1을 더해준다.
        var day = String(today.getDate()).padStart(2, '0'); // 일
        var formattedDate = year + '-' + month + '-' + day;
        $('#startdate').val(formattedDate)
        $('#enddate').val(formattedDate)

        $('#closeButton').on('click', function () {
            $('#addRowModal').modal('hide');
        });
        $('#searchingcloseButton').on('click', function () {
            $('#newModal').modal('hide');
            $('#overlay').hide();
        });
        $('#updatecloseButton').on('click', function () {
            $('#updateRowModal').modal('hide');
        });

        $('#deletecancelBtn').on('click', function () {
            $('#deleteConfirmModal').modal('hide');
        });
        load();
    });

    function showinfo(rowData) {
        console.log(rowData)
        $('#bomid-save').val(new Date().getTime());
        $('#bomid-edit').val(rowData.bomid)

        $('#productModal').modal('show');

    }
    function load() {
        $('#Datatbody').empty()
        $.ajax({
            type: 'POST',
            url: server + '/api/iteminfobom',
            dataType: 'json',
            success: function (data) {
                if (data.length === 0) {
                    $('#Datatbody').append(
                        '<tr><td colspan="13" style="text-align:center;">데이터가 없습니다</td></tr>'
                    );
                } else {
                    for (var i = 0; i < data.length; i++) {
                        var totalcost = data[i].cost !== null ? data[i].cost.toLocaleString() : '';
                        var itemprice = data[i].itemprice !== null ? data[i].itemprice.toLocaleString() : '';
                        var costPriceRatio = data[i].costPriceRatio !== null ? data[i].costPriceRatio : '';
                        var itemcode1 = data[i].itemcode !== null ? data[i].itemcode : '';
                        var fontColor = data[i].status === '미사용' ? 'silver' : '';

                        var rowData = JSON.stringify(data[i]);

                        $('#Datatbody').append(
                            '<tr>' +
                            '<td>' + data[i].bomno + '</td>' +
                            '<td>' + data[i].part + '</td>' +
                            '<td>' + data[i].customer + '</td>' +
                            '<td>' + data[i].modelname + '</td>' +
                            '<td>' + data[i].itemname + '</td>' +
                            '<td>' + itemcode1 + '</td>' +
                            '<td>' + data[i].type + '</td>' +
                            '<td>' + data[i].workpart + '</td>' +
                            '<td style="text-align:right;">' + totalcost + '</td>' +
                            '<td style="text-align:right;">' + itemprice + '</td>' +
                            '<td style="text-align:right;">' + costPriceRatio.toFixed(2) + '</td>' +
                            '<td style="text-align:right;">' + data[i].materialcount + '</td>' +
                            '<td><button class="btn btn-primary" onclick=\'showinfo(' + rowData + ')\'>상세정보</button></td>' +
                            '</tr>'
                        );
                    }
                }

            }
        });
    }
    $('#addButton').on('click', function () {
        var container = document.getElementById('containers');

        $('[id$="-save"]').val('');
        $('#costsum-save').val('0');
        $('#bomid-save').val(new Date().getTime());
        $('#bomid-edit').val('');
        $('#ordercount-save').val('1');
        $('#additionalNote').val('');
        $('#bomtableBody').empty();

        var newRow = $('<tr></tr>');

        newRow.append('<td><button id="deleteRowBtn" class="btn btn-danger" style="background-color: red; color:white; ">삭제</button></td>');
        newRow.append('<td><button id="RowBtnadd-input" class="btn btn-primary">+</button></td>');
        newRow.append('<td><input type="checkbox" id="check-input" onchange="handleCheckboxChange(this)" style="text-align:right; width: 20px; height: 20px; cursor:pointer;" autocomplete="off"></td>');
        newRow.append('<td><input type="text" id="char-input" style="text-align:right;" value="1" autocomplete="off"></td>');
        newRow.append('<td><input type="checkbox" id="main-edit" onchange="handleCheckboxChange(this)" style="text-align:right; width: 20px; height: 20px; cursor:pointer;" autocomplete="off"></td>');
        newRow.append('<td><input type="text" id="materialname-input" placeholder="자재명검색" ondblclick="handleKeyPress2(event)" onkeypress="handleKeyPress1(event)" style="cursor: pointer;" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" id="materialclassification-input" readonly style="background-color:whitesmoke; "  value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" id="etc-input" placeholder="자재 특이사항을 입력하세요" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="checkbox" onclick="handleCheckboxChange(this)" id="chk1-input" style="width: 20px; height: 20px; cursor:pointer;" autocomplete="off"></td>');
        newRow.append('<td><input type="checkbox" onclick="handleCheckboxChange(this)" id="chk2-input" style="width: 20px; height: 20px; cursor:pointer;" autocomplete="off"></td>');
        newRow.append('<td><input type="checkbox" onclick="handleCheckboxChange(this)" id="chk3-input" style="width: 20px; height: 20px; cursor:pointer;" autocomplete="off" checked></td>');
        newRow.append('<td><input type="text" style="text-align:right;" id="materialwidth-input" onkeypress="return onlyNumberKey(event)" placeholder="숫자" oninput="updateSoyoValue(); updateRlProduct(); updateRlcutValue(); calculateCost(); validateNumericInput(this);" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right;" id="useable-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right;" id="onepidding-input" placeholder="숫자" oninput="formatDecimalInput(this, 2); updateSoyoValue(); updateRlProduct(); updateRlcutValue(); calculateCost();  validateNumericInput(this);" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right;" id="twopidding-input" placeholder="숫자" oninput="formatDecimalInput(this, 2); updateSoyoValue(); updateRlProduct(); updateRlcutValue(); calculateCost(); " value="0" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" id="soyo-input" value="0" autocomplete="off" ></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;"  id="ta-input" oninput="updateSoyoValue()" value="1" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right;" id="allta-input" oninput="updateSoyoValue(); updateRlProduct(); updateRlcutValue(); calculateCost(); formatDecimalInput(this, 2);" value="1" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right;" id="talength-input" oninput="formatDecimalInput(this, 2); updateSoyoValue(); updateRlProduct(); updateRlcutValue(); calculateCost();" value="0" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right;" id="loss-input" oninput="formatDecimalInput(this, 2); updateSoyoValue(); updateRlProduct(); updateRlcutValue(); calculateCost();" value="3" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right;" id="costloss-input" oninput="formatDecimalInput(this, 2); updateSoyoValue(); updateRlProduct(); updateRlcutValue(); calculateCost();" value="3" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" oninput="formatDecimalInput(this, 2); calculateCost();" id="costsum-input" readonly value="0" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="materialaname-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="width-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="usewidth-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="length-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="rollprice-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:center; background-color: whitesmoke;" readonly id="unit-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:center; background-color: whitesmoke;" readonly id="manufacterer-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:center; background-color: whitesmoke;" readonly id="supplier-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:center; background-color: whitesmoke;" readonly id="codenumber-input"  autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="cost-input"  autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="rlcut-input"  autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="rlproduct-input"  value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="hap-materialname-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="hap-width-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="hap-usewidth-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="hap-length-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="hap-rollprice-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:center; background-color: whitesmoke;" readonly id="hap-unit-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:center; background-color: whitesmoke;" readonly id="hap-manufacterer-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:center; background-color: whitesmoke;" readonly id="hap-supplier-input" value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:center; background-color: whitesmoke;" readonly id="hap-codenumber-input"  autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="hap-cost-input"  autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="hap-rlcut-input"  autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="hap-rlproduct-input"  value="" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="cavity-input" onchange="updateSoyoValue(); updateRlProduct(); updateRlcutValue(); calculateCost();" autocomplete="off"></td>');
        newRow.append('<td><input type="text" style="text-align:right; background-color: whitesmoke;" readonly id="num-input"  autocomplete="off"></td>');

        $('#savebtn').text('저장');
        $('#bomtableBody').append(newRow);
        $('#productModal').modal('show');


    });

    function onlyNumberKey(event) {
        // Only allows number keys, backspace, delete, left and right arrows
        const charCode = event.which ? event.which : event.keyCode;
        if (charCode > 31 && (charCode < 48 || charCode > 57)) {
            return false;
        }
        return true;
    }

    function validateNumericInput(input) {
        // 숫자와 소수점만 입력 가능하게 함
        input.value = input.value.replace(/[^0-9.]/g, '');

        // 소수점이 여러 개 입력되지 않도록 함
        if ((input.value.match(/\./g) || []).length > 1) {
            input.value = input.value.replace(/\.+$/, '');
        }
    }
    function addRow() {

        var newRow = $('#bomtableBody tr:first').clone();
        $('#bomtableBody').append(newRow);
        var rowIndex = $('#bomtableBody tr').length - 1;

        newRow.find('input').each(function () {
            var originalId = $(this).attr('id');
            var newId = originalId.replace(/\d+$/, rowIndex);
            $(this).attr('id', newId);
        });

        newRow.find('#char-input').val($('#char-input:last').val());
        newRow.find('#onepidding-input').val($('#onepidding-input:first').val());
        newRow.find('#twopidding-input').val($('#twopidding-input:first').val());
        newRow.find('#ta-input').val($('#ta-input:first').val());
        newRow.find('#allta-input').val($('#allta-input:first').val());
        newRow.find('#loss-input').val($('#loss-input:first').val());
        newRow.find('#talength-input').val($('#talength-input:first').val());
        newRow.find('#cost-input').val('0');
        newRow.find('#rlcut-input').val('');
        newRow.find('#rlproduct-input').val('');
        newRow.find('#width-input').val('');
        newRow.find('#usewidth-input').val('');
        newRow.find('#length-input').val('');
        newRow.find('#rollprice-input').val('');
        newRow.find('#unit-input').val('');
        newRow.find('#manufacterer-input').val('');
        newRow.find('#supplier-input').val('');
        newRow.find('#costsum-input').val('');

        newRow.find('#hap-rlcut-input').val('');
        newRow.find('#hap-rlproduct-input').val('');
        newRow.find('#hap-materialname-input').val('');
        newRow.find('#hap-width-input').val('');
        newRow.find('#hap-usewidth-input').val('');
        newRow.find('#hap-length-input').val('');
        newRow.find('#hap-rollprice-input').val('');
        newRow.find('#hap-unit-input').val('');
        newRow.find('#hap-manufacterer-input').val('');
        newRow.find('#hap-supplier-input').val('');
        newRow.find('#hap-codenumber-input').val('');
        newRow.find('#hap-cost-input').val('');
        newRow.find('#hap-rlcut-input').val('');
        newRow.find('#hap-rlproduct-input').val('');

        newRow.find('#materialwidth-input').val('');
        newRow.find('#usable-input').val('');
        newRow.find('#etc-input').val('');
        newRow.find('#codenumber-input').val('');
        newRow.find('#num-input').val('');
        newRow.find('#chk1-input').prop('checked', false);
        newRow.find('#chk2-input').prop('checked', false);
        newRow.find('#chk3-input').prop('checked', true);
        newRow.find('#check-input').prop('checked', false);
        newRow.find('#main-edit').prop('checked', false);
        newRow.find('#materialclassification-input').val('');
        newRow.find('#materialname-input').val('');

    }

    $(document).off('click', '#deleteRowBtn').on('click', '#deleteRowBtn', function () {
        const currentRow = $(this).closest('tr');
        const tbodyLength = $('#bomtableBody').find('tr').length;

        if (tbodyLength === 1) {
            alert('첫행은 삭제 불가합니다');
        } else {
            currentRow.remove();
        }
    });

    $('#itemcode-input').on('keypress', function (event) {
        if (event.which === 13) { // Enter key code
            event.preventDefault(); // Prevent default action
            $('#overlay').show(); // Show the overlay
            $('#newModal').modal('show'); // Open the new modal

            $.ajax({
                type: 'POST',
                url: server + '/api/selectbomnoaccountinput',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({
                    itemcode: $('#itemcode-input').val()
                }),
                success: function (result) {
                    $('#itemtbody').empty(); // Clear previous results

                    if (result.length === 0) {
                        $('#no-search-row').show(); // Show "no search" row
                    } else {
                        $('#no-search-row').hide(); // Hide "no search" row
                        for (var i = 0; i < result.length; i++) {
                            $('#itemtbody').append(
                                '<tr>' +
                                '<td style="text-align:center;">' + result[i].itemcode + '</td>' +
                                '<td style="text-align:center;">' + result[i].bomno + '</td>' +
                                '<td style="text-align:center;">' + result[i].modelname + '</td>' +
                                '<td style="text-align:center;">' + result[i].itemname + '</td>' +
                                '<td style="text-align:center;">' + result[i].customer + '</td>' +
                                '<td style="text-align:center;">' + result[i].itemprice + '</td>' +
                                '<td style="text-align:center;">' +
                                '<button class="btn btn-primary" onclick="add(this); event.preventDefault();">추가</button>' +
                                '</td>' + '</tr>'
                            );
                        }
                    }

                    $("td#data-itemprice").hide(); // Hide specific cell if needed
                },

            });
        }
    });
    function handleKeyPress1(event) {
        if (event.key === "Enter") {
            var parentRow = $(event.target).closest('tr');
            // Extract data from the parent row
            var rowData = parentRow.find('td').map(function () {
                return $(this).text();
            }).get();
            var rowIndex = parentRow.index();
            $("#numericPart").val(rowIndex);
            searchingmaterial();
        }
    }

    function searchingmaterial() {
        var cavitySaveValue = $("#cavity-save").val();
        if (cavitySaveValue === '') {
            alert('Cavity가 누락되었습니다')


            return;  // Stop further execution
        }
        if ($('#bomtableBody tr:eq(' + $("#numericPart").val() + ') #materialname-input').val() === '') {
            $('#itemtbody1').empty();

            var noDataMessage = '<tr><td colspan="15">데이터가 없습니다</td></tr>';
            $('#itemtbody1').append(noDataMessage);
            $('#itemcode1-input').focus();
        } else {
            $.ajax({
                type: 'POST',
                url: server + '/api/selectbommaterial',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({
                    materialname: $('#bomtableBody tr:eq(' + $("#numericPart").val() + ') #materialname-input').val()
                }),
                success: function (result) {
                    $('#itemtbody1').empty();
                    if (result.length === 0) {
                        var noDataMessage = '<tr><td colspan="15">데이터가 없습니다</td></tr>';
                        $('#itemtbody1').append(noDataMessage);
                    } else {
                        for (var i = 0; i < result.length; i++) {
                            var row = '<tr>' +
                                '<td>' + result[i].materialname + '</td>' +
                                '<td>' + result[i].width.toLocaleString() + '</td>' +
                                '<td>' + result[i].length.toLocaleString() + '</td>' +
                                '<td>' + result[i].supplier + '</td>' +
                                '<td class="data-width">' + result[i].width + '</td>' +
                                '<td class="data-usewidth">' + result[i].usewidth + '</td>' +
                                '<td class="data-length">' + result[i].length + '</td>' +
                                '<td class="data-sqmprice">' + result[i].sqmprice + '</td>' +
                                '<td class="data-rollprice">' + result[i].rollprice + '</td>' +
                                '<td class="data-unit">' + result[i].unit + '</td>' +
                                '<td class="data-manufacterer">' + result[i].manufacterer + '</td>' +
                                '<td class="data-supplier">' + result[i].supplier + '</td>' +
                                '<td class="data-typecategory">' + result[i].typecategory + '</td>' +
                                '<td class="data-codenumber">' + result[i].codenumber + '</td>' +
                                '<td>' + result[i].num + '</td>' +
                                '<td><button class="btn btn-primary" onclick="insertmaterialdata(this)" >추가</button></td>' +
                                '</tr>';

                            $('#itemtbody1').append(row);
                        }

                        // 한 번의 선택으로 모든 숨길 요소를 처리합니다.
                        $('#itemtbody1').find('.data-width, .data-usewidth, .data-length, .data-sqmprice, .data-rollprice, .data-unit, .data-manufacterer, .data-supplier, .data-codenumber').hide();
                    }
                }
            });
        }

        $("#itemcode1-input").val('');
        $('#overlay').show(); // Show the overlay
        $('#newModal').modal('show'); // Open the new modal
    }
    function insertmaterialdata(button) {
        var parentRow = $(button).closest('tr');
        var rowData = parentRow.find('td').map(function () {
            return $(this).text();
        }).get();

        var rowIndex = $('#numericPart').val();
        var targetRow = $('#bomtableBody tr:eq(' + rowIndex + ')');

        // Ensure the row exists
        if (targetRow.length === 0) {
            console.error('Specified row does not exist');
            return;
        }

        // Update input fields in the specified row
        targetRow.find('#materialname-input').val(rowData[0]);
        targetRow.find('#materialaname-input').val(rowData[0]);
        targetRow.find('#materialclassification-input').val(rowData[12]);
        targetRow.find('#width-input').val(rowData[4]);
        targetRow.find('#usewidth-input').val(rowData[5]);
        targetRow.find('#length-input').val(rowData[6]);
        targetRow.find('#sqmprice-input').val(rowData[7]);
        targetRow.find('#rollprice-input').val(rowData[8]);
        targetRow.find('#unit-input').val(rowData[9]);
        targetRow.find('#manufacterer-input').val(rowData[10]);
        targetRow.find('#supplier-input').val(rowData[11]);
        targetRow.find('#codenumber-input').val(rowData[13]);
        targetRow.find('#num-input').val(parseFloat(rowIndex) + 1);

        var useWidth = parseFloat(targetRow.find('#usewidth-input').val().replace(/,/g, '')) || 0;
        var materialWidth = parseFloat(targetRow.find('#materialwidth-input').val().replace(/,/g, '')) || 0;

        targetRow.find('.rlcut-input').val(Math.floor(useWidth / materialWidth));

        let lengthValue = parseFloat(targetRow.find('#length-input').val()) || 0;
        let rlcutValue = parseFloat(targetRow.find('#rlcut-input').val()) || 0;
        let cavitySaveValue = parseFloat(targetRow.find('#cavity-input').val()) || 0;
        let onepiddingValue = parseFloat(targetRow.find('#onepidding-input').val()) || 0;
        let taLengthValue = parseFloat(targetRow.find('#talength-input').val()) || 0;
        let twopiddingValue = parseFloat(targetRow.find('#twopidding-input').val()) || 0;
        let alltaValue = parseFloat(targetRow.find('#allta-input').val()) || 0;
        let lossValue = parseFloat(targetRow.find('#loss-input').val()) || 0;

        let rlproductValue = ((lengthValue * 1000 * rlcutValue * cavitySaveValue * (1 + (lossValue / 100))) / ((onepiddingValue + taLengthValue + twopiddingValue) / alltaValue)).toFixed(0);
        targetRow.find('#rlproduct-input').val(rlproductValue);

        const rollpriceInput = targetRow.find('#rollprice-input');
        const rollpriceValue = parseFloat(rollpriceInput.val().replace(/,/g, '')) || 0;
        const costValue = rollpriceValue / rlproductValue;

        targetRow.find('#cost-input').val(costValue.toFixed(2));

        // Hide the modal and overlay
        $('#overlay').hide();
        $('#newModal').modal('hide');

        // Prevent default button action (form submit or link follow)
        event.preventDefault();
        return false; // For good measure
    }


    function habji() {
        // Collect checked rows and their relevant data
        var checkedRows = $('input[id="check-input"]:checked').map(function () {
            var row = $(this).closest('tr');
            var materialnameValue = row.find('#materialname-input').val();
            var materialWidthValue = row.find('#width-input').val();
            var useWidthValue = row.find('#usewidth-input').val();
            var lengthValue = row.find('#length-input').val();
            var sqmpriceValue = row.find('#sqmprice-input').val();
            var rollpriceValue = row.find('#rollprice-input').val();
            var unitValue = row.find('#unit-input').val();
            var manufactererValue = row.find('#manufacterer-input').val();
            var supplierValue = row.find('#supplier-input').val();
            var codenumberValue = row.find('#codenumber-input').val();
            return {
                row: row,
                materialnameValue: materialnameValue,
                materialWidthValue: materialWidthValue,
                useWidthValue: useWidthValue,
                lengthValue: lengthValue,
                sqmpriceValue: sqmpriceValue,
                rollpriceValue: rollpriceValue,
                unitValue: unitValue,
                manufactererValue: manufactererValue,
                supplierValue: supplierValue,
                codenumberValue: codenumberValue
            };
        }).get();

        // Check if exactly two rows are selected
        if (checkedRows.length === 2) {
            var concatenatedValue = checkedRows[0].materialnameValue + '+' + checkedRows[1].materialnameValue;

            // Update the first row with concatenated value and clear the second row's inputs
            checkedRows[0].row.find('#materialname-input').val(concatenatedValue);
            checkedRows[0].row.find('#materialclassification-input').val('HAP');
            checkedRows[1].row.find('#materialname-input').val('');
            checkedRows[1].row.find('#materialaname-input').val('');
            checkedRows[1].row.find('#materialclassification-input').val('');
            checkedRows[1].row.find('#cost-input').val('');
            checkedRows[1].row.find('#rlcut-input').val('');
            checkedRows[1].row.find('#rlproduct-input').val('');
            checkedRows[1].row.find('#width-input').val('');
            checkedRows[1].row.find('#usewidth-input').val('');
            checkedRows[1].row.find('#length-input').val('');
            checkedRows[1].row.find('#sqmprice-input').val('');
            checkedRows[1].row.find('#rollprice-input').val('');
            checkedRows[1].row.find('#unit-input').val('');
            checkedRows[1].row.find('#manufacterer-input').val('');
            checkedRows[1].row.find('#supplier-input').val('');
            checkedRows[1].row.find('#hap-cost-input').val('');
            checkedRows[1].row.find('#hap-rlcut-input').val('');
            checkedRows[1].row.find('#hap-rlproduct-input').val('');
            checkedRows[1].row.find('#hap-width-input').val('');
            checkedRows[1].row.find('#hap-usewidth-input').val('');
            checkedRows[1].row.find('#hap-length-input').val('');
            checkedRows[1].row.find('#hap-sqmprice-input').val('');
            checkedRows[1].row.find('#hap-rollprice-input').val('');
            checkedRows[1].row.find('#hap-unit-input').val('');
            checkedRows[1].row.find('#hap-manufacterer-input').val('');
            checkedRows[1].row.find('#hap-supplier-input').val('');
            checkedRows[1].row.find('#hap-rlcut-input').val('');
            checkedRows[1].row.find('#hap-rlproduct-input').val('');
            checkedRows[1].row.find('#codenumber-input').val('');
            checkedRows[1].row.find('#num-input').val('');
            checkedRows[1].row.find('#materialwidth-input').val('');
            checkedRows[1].row.find('#onepidding-input').val('');
            checkedRows[1].row.find('#costsum-input').val('');

            // Additional update and focus on the first row
            checkedRows[0].row.find('#materialwidth-input').val('');
            checkedRows[0].row.find('#materialwidth-input').focus();

            // Update the hap fields in the first row
            checkedRows[0].row.find('#hap-materialname-input').val(checkedRows[1].materialnameValue);
            checkedRows[0].row.find('#hap-width-input').val(checkedRows[1].materialWidthValue);
            checkedRows[0].row.find('#hap-usewidth-input').val(checkedRows[1].useWidthValue);
            checkedRows[0].row.find('#hap-length-input').val(checkedRows[1].lengthValue);
            checkedRows[0].row.find('#hap-sqmprice-input').val(checkedRows[1].sqmpriceValue);
            checkedRows[0].row.find('#hap-rollprice-input').val(checkedRows[1].rollpriceValue);
            checkedRows[0].row.find('#hap-unit-input').val(checkedRows[1].unitValue);
            checkedRows[0].row.find('#hap-manufacterer-input').val(checkedRows[1].manufactererValue);
            checkedRows[0].row.find('#hap-supplier-input').val(checkedRows[1].supplierValue);
            checkedRows[0].row.find('#hap-codenumber-input').val(checkedRows[1].codenumberValue);

            // Uncheck all checked checkboxes
            $('input[id="check-input"]:checked').prop('checked', false);
        } else {
            // Show an error message if exactly two rows are not selected
            alert('합지는 2개 선택 시 가능합니다');
        }
    }
    function Bomsave() {
        function showMissingFieldAlert(fieldName, message) {
            alert(message);
        }

        if ($('#bomno-save').val() === '') {
            showMissingFieldAlert('BOMNO', 'BOMNO가 누락되었습니다');
            return;
        }
        if ($('#customer-save').val() === '') {
            showMissingFieldAlert('고객사', '고객사가 누락되었습니다');
            return;
        }
        if ($('#modelname-save').val() === '') {
            showMissingFieldAlert('모델명', '모델명이 누락되었습니다');
            return;
        }
        if ($('#itemname-save').val() === '') {
            showMissingFieldAlert('제품명', '제품명이 누락되었습니다');
            return;
        }
        if ($('#pcs-save').val() === '') {
            showMissingFieldAlert('PCS', 'PCS가 누락되었습니다');
            return;
        }
        if ($('#cavity-save').val() === '') {
            showMissingFieldAlert('cavity', 'cavity가 누락되었습니다');
            return;
        }
        if ($('#itemcode-save').val() === '') {
            showMissingFieldAlert('itemcode', '고객코드가 누락되었습니다');
            return;
        }
        if ($('#workpart-save').val() === '') {
            showMissingFieldAlert('공정구분', '공정구분이 누락되었습니다');
            return;
        }
        if ($('#working-save').val() === '') {
            showMissingFieldAlert('작업차수', '작업차수가 누락되었습니다');
            return;
        }
        if ($('#direction-save').val() === '') {
            showMissingFieldAlert('타발방향', '타발방향이 누락되었습니다');
            return;
        }
        if ($('#type-save').val() === '') {
            showMissingFieldAlert('type', 'type이 누락되었습니다');
            return;
        }

        let tableBody = document.getElementById('bomtableBody');
        if (tableBody) {
            let rowCount = tableBody.children.length;

            for (let i = 0; i < rowCount; i++) {
                var materialname = $('#bomtableBody tr:eq(' + i + ') #materialname-input').val();
                var materialwidth = $('#bomtableBody tr:eq(' + i + ') #materialwidth-input').val();
                var onepidding = $('#bomtableBody tr:eq(' + i + ') #onepidding-input').val();
                var twopidding = $('#bomtableBody tr:eq(' + i + ') #twopidding-input').val();
                var char = $('#bomtableBody tr:eq(' + i + ') #char-input').val();
                if (materialname === '' || materialwidth === '' || onepidding === '' || twopidding === '' || char === '') {
                    alert(`${i + 1}번째 필수 입력 항목이 누락되었습니다.`);
                    return;
                }
            }
        }

        if (tableBody) {
            let rowCount = tableBody.children.length;

            for (let i = 0; i < rowCount; i++) {
                var materialWidthValue = $('#bomtableBody tr:eq(' + i + ') #materialwidth-input').val();
                var useWidthValue = $('#bomtableBody tr:eq(' + i + ') #usewidth-input').val();

                if (parseFloat(materialWidthValue) > parseFloat(useWidthValue)) {
                    alert(`${i + 1}번째 원단폭이 유효폭보다 클 수 없습니다.`);
                    return;
                }
            }
        }

        if ($('#bomid-edit').val()) {
            var insertdate = new Date().toISOString().slice(0, 10);
            var confirmResult = confirm('BOM정보(양산) 데이터를 수정하시겠습니까?');
            if (confirmResult) {
                $.ajax({
                    type: 'POST',
                    url: server + '/api/updateiteminformation',
                    dataType: 'json',
                    async: false,
                    contentType: 'application/json',
                    data: JSON.stringify({
                        "bomno": $('#bomno-save').val(),
                        "modelname": $('#modelname-save').val(),
                        "itemname": $('#itemname-save').val(),
                        "customer": $('#customer-save').val(),
                        "itemcode": $('#itemcode-save').val(),
                        "pcs": $('#pcs-save').val(),
                        "cavity": $('#cavity-save').val(),
                        "direction": $('#direction-save').val(),
                        "workpart": $('#workpart-save').val(),
                        "additionalnotes": $('#additionalNote').val(),
                        "working": $('#working-save').val(),
                        "type": $('#type-save').val(),
                    }),
                    success: function (result) {
                        // Handle success
                    }
                });

                $.ajax({
                    type: 'POST',
                    url: server + '/api/updatebomstatus',
                    dataType: 'json',
                    async: false,
                    contentType: 'application/json',
                    data: JSON.stringify({
                        "bomid": $('#bomid-edit').val(),
                        "status": 'false'
                    }),
                    success: function (result) {
                        // Handle success
                    }
                });

                $('[id^="num-input"]').each(function (index) {
                    var cavity = $('#cavity-save').val();
                    var bomno = $('#bomno-save').val();
                    var model = $('#modelname-save').val();
                    var itemname = $('#itemname-save').val();
                    var materialname = $('[id^="materialname-input"]').eq(index).val();
                    var char = $('[id^="char-input"]').eq(index).val();
                    var main = $('[id^="main-edit"]').eq(index).prop('checked') ? '메인자재' : '';
                    var etc = $('[id^="etc-input"]').eq(index).val();
                    var materialwidth = parseFloat($('[id^="materialwidth-input"]').eq(index).val()) || 0;
                    var onepid = ($('[id^="onepidding-input"]').eq(index).val())
                    var twopid = ($('[id^="twopidding-input"]').eq(index).val())
                    var soyo = ($('[id^="soyo-input"]').eq(index).val())
                    var ta = ($('[id^="ta-input"]').eq(index).val())
                    var allta = ($('[id^="allta-input"]').eq(index).val())
                    var talength = ($('[id^="talength-input"]').eq(index).val())
                    var loss = ($('[id^="loss-input"]').eq(index).val())
                    var num = ($('[id^="num-input"]').eq(index).val());
                    var cavity = ($('[id^="cavity-input"]').eq(index).val());
                    var codenumber = ($('[id^="codenumber-input"]').eq(index).val());
                    var useable = ($('[id^="useable-input"]').eq(index).val());
                    var bomid = $('#bomid-save').val();
                    var costloss = ($('[id^="costloss-input"]').eq(index).val());
                    var chk1 = $('[id^="chk1-input"]').eq(index).prop('checked') ? true : false;
                    var chk2 = $('[id^="chk2-input"]').eq(index).prop('checked') ? true : false;
                    var chk3 = $('[id^="chk3-input"]').eq(index).prop('checked') ? true : false;

                    $.ajax({
                        type: 'POST',
                        url: server + '/api/bommasssavebommanagement',
                        dataType: 'json',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            "savedate": insertdate,
                            "bomno": bomno,
                            "model": model,
                            "itemname": itemname,
                            "materialname": materialname,
                            "status": 'true',
                            "char": char,
                            "main": main,
                            "etc": etc,
                            "materialwidth": materialwidth,
                            "onepid": onepid,
                            "twopid": twopid,
                            "ta": ta,
                            "allta": allta,
                            "talength": talength,
                            "loss": loss,
                            "cavity": cavity,
                            "codenumber": codenumber,
                            "useable": useable,
                            "num": num,
                            "costloss": costloss,
                            "bomid": bomid,
                            "chk1": chk1,
                            "chk2": chk2,
                            "chk3": chk3
                        }),
                        success: function (result) {
                            // Handle success
                        },
                        error: function (error) {
                            // Handle error
                        },
                    });
                });

                $('#newModal').modal('hide');
                alert('데이터가 성공적으로 수정 되었습니다.');
                load();
            }
        } else {
            $.ajax({
                type: 'POST',
                url: server + '/api/bommasssavebommanagement',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({
                    "bomno": $('#bomno-save').val(),
                    "modelname": $('#modelname-save').val(),
                    "itemname": $('#itemname-save').val(),
                    "customer": $('#customer-save').val(),
                    "itemcode": $('#itemcode-save').val(),
                    "pcs": $('#pcs-save').val(),
                    "cavity": $('#cavity-save').val(),
                    "direction": $('#direction-save').val(),
                    "workpart": $('#workpart-save').val(),
                    "additionalnotes": $('#additionalNote').val(),
                    "working": $('#working-save').val(),
                    "type": $('#type-save').val(),
                }),
                success: function (result) {
                    // Handle success
                },
                error: function (error) {
                    // Handle error
                },
            });

            $('[id^="num-input"]').each(function (index) {
                var cavity = $('#cavity-save').val();
                var bomno = $('#bomno-save').val();
                var model = $('#modelname-save').val();
                var itemname = $('#itemname-save').val();
                var materialname = $('[id^="materialname-input"]').eq(index).val();
                var char = $('[id^="char-input"]').eq(index).val();
                var main = $('[id^="main-edit"]').eq(index).prop('checked') ? '메인자재' : '';
                var etc = $('[id^="etc-input"]').eq(index).val();
                var materialwidth = parseFloat($('[id^="materialwidth-input"]').eq(index).val()) || 0;
                var onepid = ($('[id^="onepidding-input"]').eq(index).val())
                var twopid = ($('[id^="twopidding-input"]').eq(index).val())
                var soyo = ($('[id^="soyo-input"]').eq(index).val())
                var ta = ($('[id^="ta-input"]').eq(index).val())
                var allta = ($('[id^="allta-input"]').eq(index).val())
                var talength = ($('[id^="talength-input"]').eq(index).val())
                var loss = ($('[id^="loss-input"]').eq(index).val())
                var num = ($('[id^="num-input"]').eq(index).val());
                var cavity = ($('[id^="cavity-input"]').eq(index).val());
                var codenumber = ($('[id^="codenumber-input"]').eq(index).val());
                var useable = ($('[id^="useable-input"]').eq(index).val());
                var bomid = $('#bomid-save').val();
                var costloss = ($('[id^="costloss-input"]').eq(index).val());
                var chk1 = $('[id^="chk1-input"]').eq(index).prop('checked') ? true : false;
                var chk2 = $('[id^="chk2-input"]').eq(index).prop('checked') ? true : false;
                var chk3 = $('[id^="chk3-input"]').eq(index).prop('checked') ? true : false;

                $.ajax({
                    type: 'POST',
                    url: server + '/api/bommasssavebommanagement',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        "savedate": insertdate,
                        "bomno": bomno,
                        "model": model,
                        "itemname": itemname,
                        "materialname": materialname,
                        "status": 'true',
                        "char": char,
                        "main": main,
                        "etc": etc,
                        "materialwidth": materialwidth,
                        "onepid": onepid,
                        "twopid": twopid,
                        "ta": ta,
                        "allta": allta,
                        "talength": talength,
                        "loss": loss,
                        "cavity": cavity,
                        "codenumber": codenumber,
                        "useable": useable,
                        "num": num,
                        "costloss": costloss,
                        "bomid": bomid,
                        "chk1": chk1,
                        "chk2": chk2,
                        "chk3": chk3
                    }),
                    success: function (result) {
                        // Handle success
                    },
                    error: function (error) {
                        // Handle error
                    },
                });
            });

            $('#newModal').modal('hide');
            alert('데이터가 성공적으로 저장 되었습니다.');
            load();
        }
    }

</script>
<script>
    function updateCavity() {
        const cavitySaveValue = parseFloat($("#cavity-save").val()) || 0;
        const taInputValue = cavitySaveValue !== 0 ? (1 / cavitySaveValue) : 0;
        $("[id='cavity-input']").val(cavitySaveValue);
    }

    function updateRlcutValue() {
        var currentRow = $(event.target).closest('tr');
        var rowIndex = currentRow.index();
        $('#bomtableBody tr:eq(' + rowIndex + ') #rlcut-input').val(
            Math.floor(
                parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #usewidth-input').val()) /
                parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #materialwidth-input').val())
            ) || 0
        );
        $('#bomtableBody tr:eq(' + rowIndex + ') #hap-rlcut-input').val(
            Math.floor(
                parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #hap-usewidth-input').val()) /
                parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #materialwidth-input').val())
            ) || 0
        );
    }

    function updateSoyoValue() {
        var currentRow = $(event.target).closest('tr');
        var rowIndex = currentRow.index();
        const taValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #ta-input').val()) || 0;
        const onepiddingValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #onepidding-input').val()) || 0;
        const taLengthValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #talength-input').val()) || 0;
        const twopiddingValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #twopidding-input').val()) || 0;
        const alltaValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #allta-input').val()) || 0;
        const lossValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #loss-input').val()) || 0;

        let soyoValue = (taValue * ((onepiddingValue + taLengthValue + twopiddingValue) / alltaValue) * 0.001 * (1 + (lossValue / 100))).toFixed(4);
        soyoValue = soyoValue.replace(/\.?0+$/, '');

        $('#bomtableBody tr:eq(' + rowIndex + ') #soyo-input').val(soyoValue);
    }

    function updateRlProduct() {
        var currentRow = $(event.target).closest('tr');
        var rowIndex = currentRow.index();

        let materialWidthValue = $('#bomtableBody tr:eq(' + rowIndex + ') #materialwidth-input').val().trim();
        if (materialWidthValue === '') {
            return;
        }

        let materialWidth = parseFloat(materialWidthValue) || 0;
        let lengthValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #length-input').val()) || 0;
        let rlcutValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #rlcut-input').val()) || 0;
        let cavitySaveValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #cavity-input').val()) || 0;
        let onepiddingValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #onepidding-input').val()) || 0;
        let taLengthValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #talength-input').val()) || 0;
        let twopiddingValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #twopidding-input').val()) || 0;
        let alltaValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #allta-input').val()) || 0;
        let lossValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #loss-input').val()) || 0;

        let useWidthValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #usewidth-input').val()) || 0;
        let hapUseWidthValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #hap-usewidth-input').val()) || 0;

        let rlcutValue1 = Math.floor(useWidthValue / materialWidth) || 0;
        let rlcutValueA = Math.floor(hapUseWidthValue / materialWidth) || 0;

        let rlproductValue = ((lengthValue * 1000 * rlcutValue1 * cavitySaveValue * (1 + (lossValue / 100))) / ((onepiddingValue + taLengthValue + twopiddingValue) / alltaValue)).toFixed(0);
        rlproductValue = isFinite(rlproductValue) && !isNaN(rlproductValue) ? rlproductValue : 0;

        let rlproductValueA = ((lengthValue * 1000 * rlcutValueA * cavitySaveValue * (1 + (lossValue / 100))) / ((onepiddingValue + taLengthValue + twopiddingValue) / alltaValue)).toFixed(0);
        rlproductValueA = isFinite(rlproductValueA) && !isNaN(rlproductValueA) ? rlproductValueA : 0;

        $('#bomtableBody tr:eq(' + rowIndex + ') #rlproduct-input').val(rlproductValue);
        $('#bomtableBody tr:eq(' + rowIndex + ') #hap-rlproduct-input').val(rlproductValueA);
    }

    function calculateCost() {
        var currentRow = $(event.target).closest('tr');
        var rowIndex = currentRow.index();
        const rollpriceInput = $('#bomtableBody tr:eq(' + rowIndex + ') #rollprice-input');
        const rollpriceValue = parseFloat(rollpriceInput.val()) || 0;
        const rollpriceInputA = $('#bomtableBody tr:eq(' + rowIndex + ') #hap-rollprice-input');
        const rollpriceValueA = parseFloat(rollpriceInputA.val()) || 0;

        let lengthValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #length-input').val()) || 0;
        let rlcutValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #rlcut-input').val()) || 0;
        let lengthValueA = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #hap-length-input').val()) || 0;
        let rlcutValueA = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #hap-rlcut-input').val()) || 0;

        let onepiddingValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #onepidding-input').val()) || 0;
        let twopiddingValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #twopidding-input').val()) || 0;
        let alltaValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #allta-input').val()) || 0;
        let lossValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #costloss-input').val()) || 0;
        let taLengthValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #talength-input').val()) || 0;
        let cavitySaveValue = parseFloat($('#bomtableBody tr:eq(' + rowIndex + ') #cavity-input').val()) || 0;

        let rlproductValue = ((lengthValue * 1000 * rlcutValue * cavitySaveValue * (1 - (lossValue / 100))) / ((onepiddingValue + taLengthValue + twopiddingValue) / alltaValue)).toFixed(0);
        rlproductValue = isFinite(rlproductValue) && !isNaN(rlproductValue) ? rlproductValue : 0;

        const costValue = rollpriceValue / rlproductValue || 0;

        let rlproductValueA = ((lengthValueA * 1000 * rlcutValueA * cavitySaveValue * (1 - (lossValue / 100))) / ((onepiddingValue + taLengthValue + twopiddingValue) / alltaValue)).toFixed(0);
        rlproductValueA = isFinite(rlproductValueA) && !isNaN(rlproductValueA) ? rlproductValueA : 0;

        const costValueA = rollpriceValueA / rlproductValueA || 0;

        // 값 설정하기
        $('#bomtableBody tr:eq(' + rowIndex + ') #cost-input').val(isFinite(costValue) && !isNaN(costValue) ? costValue.toFixed(2) : 0);
        $('#bomtableBody tr:eq(' + rowIndex + ') #hap-cost-input').val(isFinite(costValueA) && !isNaN(costValueA) ? costValueA.toFixed(2) : 0);
        $('#bomtableBody tr:eq(' + rowIndex + ') #costsum-input').val((costValue + costValueA).toFixed(2));


        var totalCostSum = 0;
        $('#bomtableBody tr').each(function () {
            var costSumValue = parseFloat($(this).find('#costsum-input').val()) || 0;
            totalCostSum += costSumValue;
        });
        $('#costsum-save').val(totalCostSum.toFixed(2))
        return totalCostSum;

    }


    document.getElementById('cavity-save').addEventListener('input', updateCavity);


</script>

</html>